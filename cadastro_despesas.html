<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Despesas</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="menu-adm.css">

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#b03a2e;
  --logo:#D0B485;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
body{margin:0;background:var(--bege);display:none}
header{background:var(--logo);padding:14px;text-align:center;font-weight:700;font-size:17px}
.container{max-width:760px;margin:16px auto;padding:16px;background:#fff;border-radius:12px}
label{font-weight:600;margin-top:10px;display:block;font-size:14px}
input,select,textarea{
  width:100%;
  padding:10px 12px;
  margin-top:4px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px
}
textarea{resize:vertical}
button{
  width:100%;
  padding:12px;
  margin-top:14px;
  border:none;
  font-size:15px;
  cursor:pointer;
  border-radius:10px
}
.salvar{background:var(--verde);color:#fff}
.excluir{background:var(--vermelho);color:#fff}
.hidden{display:none}
</style>
</head>

<body>

<div id="app" class="hidden">

<header>Cadastro de Despesas</header>
<div id="menu-adm"></div>

<div class="container">

<label>Ação</label>
<select id="acao">
  <option value="novo">Novo registro</option>
  <option value="editar">Editar registro</option>
</select>

<div id="blocoEdicao" class="hidden">
  <label>Ano</label>
  <select id="ano"></select>

  <label>Mês</label>
  <select id="mes"></select>

  <label>Despesa existente</label>
  <select id="despesaExistente"></select>
</div>

<label>Nome da despesa</label>
<input id="nome_despesa">

<label>Tipo da despesa</label>
<input id="tipo_despesa">

<label>Categoria</label>
<select id="categoria_despesa">
  <option value="">Selecione</option>
  <option>Alimentação</option>
  <option>Estruturas</option>
  <option>Manutenção/Reparos</option>
  <option>Medicamentos</option>
  <option>Melhorias</option>
</select>

<label>Fornecedor</label>
<input id="fornecedor">

<label>Forma de pagamento</label>
<select id="forma_pagamento">
  <option value="">Selecione</option>
  <option>Dinheiro</option>
  <option>Pix</option>
  <option>Cartão</option>
  <option>Fiado</option>
</select>

<label>Status do pagamento</label>
<select id="status_pagamento">
  <option value="Pago">Pago</option>
  <option value="Pendente">Pendente</option>
</select>

<label>Quantidade</label>
<input id="quantidade" type="number" step="0.01">

<label>Valor unitário</label>
<input id="valor_unitario" type="number" step="0.01">

<label>Valor total</label>
<input id="valor_total" type="number" step="0.01" readonly>

<label>Data de vencimento</label>
<input id="data_vencimento" type="date">

<label>Observações</label>
<textarea id="observacoes"></textarea>

<button class="salvar" onclick="salvar()">Salvar</button>
<button id="btnExcluir" class="excluir hidden" onclick="excluir()">Excluir</button>

</div>
</div>

<script>
/* ELEMENTOS */
const blocoEdicao = document.getElementById("blocoEdicao");
const btnExcluir  = document.getElementById("btnExcluir");

/* MENU */
fetch("menu-adm.html")
  .then(r=>r.text())
  .then(h=>{
    document.getElementById("menu-adm").innerHTML = h;
    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")==="cadastro_despesas.html"){
        a.classList.add("ativo");
      }
    });
  });

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});
const auth = firebase.auth();
const db   = firebase.firestore();

/* LOGOUT */
function logout(){
  auth.signOut().then(()=>location.href="index.html");
}

/* AUTH */
auth.onAuthStateChanged(user=>{
  if(user){
    document.body.style.display="block";
    document.getElementById("app").classList.remove("hidden");
    carregarDespesas();
  }else{
    location.href="index.html";
  }
});

let despesas=[];
let despesaAtual=null;

/* TOTAL */
quantidade.oninput = calcularTotal;
valor_unitario.oninput = calcularTotal;
function calcularTotal(){
  valor_total.value =
    (Number(quantidade.value||0)*Number(valor_unitario.value||0)).toFixed(2);
}

/* AÇÃO */
acao.onchange=()=>{
  blocoEdicao.classList.toggle("hidden",acao.value!=="editar");
  btnExcluir.classList.add("hidden");
  limpar();
};

/* LOAD */
async function carregarDespesas(){
  const snap = await db.collection("despesas").get();
  despesas = snap.docs.map(d=>({id:d.id,...d.data()}));

  const anos=[...new Set(despesas.map(d=>d.ano))].sort();
  ano.innerHTML='<option value="">Selecione</option>';
  anos.forEach(a=>ano.innerHTML+=`<option>${a}</option>`);
}

ano.onchange=()=>{
  mes.innerHTML='<option value="">Selecione</option>';
  despesaExistente.innerHTML='<option value="">Selecione</option>';
  despesas.filter(d=>d.ano===ano.value)
    .map(d=>d.mes)
    .filter((v,i,a)=>a.indexOf(v)===i)
    .sort()
    .forEach(m=>mes.innerHTML+=`<option>${m}</option>`);
};

mes.onchange=()=>{
  despesaExistente.innerHTML='<option value="">Selecione</option>';
  despesas.filter(d=>d.ano===ano.value && d.mes===mes.value)
    .forEach(d=>{
      despesaExistente.innerHTML+=`<option value="${d.id}">${d.nome_despesa}</option>`;
    });
};

despesaExistente.onchange=()=>{
  despesaAtual = despesas.find(d=>d.id===despesaExistente.value);
  if(!despesaAtual) return;
  Object.keys(despesaAtual).forEach(k=>{
    if(document.getElementById(k)) document.getElementById(k).value=despesaAtual[k];
  });
  btnExcluir.classList.remove("hidden");
};

/* SALVAR */
async function salvar(){
  if(!nome_despesa.value || !categoria_despesa.value || !fornecedor.value ||
     !valor_total.value || !data_vencimento.value){
    alert("Preencha todos os campos obrigatórios.");
    return;
  }

  const hoje=new Date();
  const dados={
    nome_despesa:nome_despesa.value,
    tipo_despesa:tipo_despesa.value,
    categoria_despesa:categoria_despesa.value,
    fornecedor:fornecedor.value,
    forma_pagamento:forma_pagamento.value,
    status_pagamento:status_pagamento.value,
    quantidade:quantidade.value,
    valor_unitario:valor_unitario.value,
    valor_total:valor_total.value,
    data_vencimento:data_vencimento.value,
    observacoes:observacoes.value,
    ano:String(ano.value||hoje.getFullYear()),
    mes:String(mes.value||hoje.getMonth()+1),
    dia:String(hoje.getDate())
  };

  if(despesaAtual){
    await db.collection("despesas").doc(despesaAtual.id).update(dados);
    alert("Despesa atualizada com sucesso.");
  }else{
    await db.collection("despesas").add(dados);
    alert("Despesa cadastrada com sucesso.");
  }
  location.reload();
}

/* EXCLUIR */
async function excluir(){
  if(confirm("Excluir esta despesa?")){
    await db.collection("despesas").doc(despesaAtual.id).delete();
    alert("Despesa excluída com sucesso.");
    location.reload();
  }
}

function limpar(){
  document.querySelectorAll("input,select,textarea").forEach(e=>{
    if(!["acao","ano","mes","despesaExistente"].includes(e.id)) e.value="";
  });
  despesaAtual=null;
}
</script>

</body>
</html>
