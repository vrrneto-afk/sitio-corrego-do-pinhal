<!-- RELATÓRIOS — LAYOUT TRAVADO -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const hoje = new Date();

  function anoDataBR(data) {
    if (!data) return null;
    const [d, m, y] = data.split("/");
    return new Date(`${y}-${m}-${d}`);
  }

  /* ==========================
     FILTRO DE ESPÉCIE
  ========================== */
  let especieSelecionada = "Bovino";

  function filtrarAnimais(animais) {
    return animais.filter(a =>
      a.status === "Ativo" &&
      (especieSelecionada === "Todas" || a.especie === especieSelecionada)
    );
  }

  /* ==========================
     RESUMO DO REBANHO
  ========================== */
  function calcularResumo(animais, eventos) {

    const ativos = filtrarAnimais(animais);

    const partos = eventos.filter(e => e.tipo_evento === "parto");

    const vacasParidasIds = new Set(partos.map(p => p.id_animal));

    const vacas = ativos.filter(a =>
      a.sexo === "F" && a.especie === "Bovino" && vacasParidasIds.has(a.id_animal)
    );

    const novilhas = ativos.filter(a =>
      a.sexo === "F" && a.especie === "Bovino" && !vacasParidasIds.has(a.id_animal)
    );

    const bezerros = ativos.filter(a => {
      const nasc = anoDataBR(a.data_nascimento);
      if (!nasc) return false;
      const meses = (hoje - nasc) / (1000 * 60 * 60 * 24 * 30);
      return meses < 12;
    });

    const touros = ativos.filter(a =>
      a.sexo === "M" &&
      a.observacoes &&
      a.observacoes.toLowerCase().includes("touro")
    );

    document.getElementById("totalAnimais").innerText = ativos.length;
    document.getElementById("totalVacas").innerText = vacas.length;
    document.getElementById("totalNovilhas").innerText = novilhas.length;
    document.getElementById("totalBezerros").innerText = bezerros.length;
    document.getElementById("totalTouros").innerText = touros.length;
  }

  /* ==========================
     SITUAÇÃO REPRODUTIVA
  ========================== */
  function calcularReproducao(animais, eventos) {

    const ativos = filtrarAnimais(animais);
    const coberturas = eventos.filter(e => e.tipo_evento === "cobertura");
    const partos = eventos.filter(e => e.tipo_evento === "parto");

    const prenhas = new Set();
    coberturas.forEach(c => {
      const jaPariu = partos.some(p =>
        p.id_animal === c.id_animal &&
        anoDataBR(p.data_evento) > anoDataBR(c.data_evento)
      );
      if (!jaPariu) prenhas.add(c.id_animal);
    });

    const paridas = new Set(partos.map(p => p.id_animal));

    const vacasAtivas = ativos.filter(a => a.sexo === "F");

    const vazias = vacasAtivas.filter(v =>
      !prenhas.has(v.id_animal) && !paridas.has(v.id_animal)
    );

    document.getElementById("totalPrenhas").innerText = prenhas.size;
    document.getElementById("totalParidas").innerText = paridas.size;
    document.getElementById("totalVazias").innerText = vazias.length;
  }

  /* ==========================
     PRODUÇÃO (PARTOS)
  ========================== */
  function calcularPartos(eventos, ano) {
    const total = eventos.filter(e =>
      e.tipo_evento === "parto" &&
      anoDataBR(e.data_evento)?.getFullYear() === ano
    ).length;

    document.getElementById("totalPartosAno").innerText = total;
  }

  /* ==========================
     SANITÁRIO (VACINAS)
  ========================== */
  function calcularVacinas(vacinas, ano) {

    const aplicadas = vacinas.filter(v =>
      anoDataBR(v.data_aplicacao)?.getFullYear() === ano
    );

    document.getElementById("totalVacinasAno").innerText = aplicadas.length;

    const agrupadas = {};
    aplicadas.forEach(v => {
      agrupadas[v.vacina_aplicada] = (agrupadas[v.vacina_aplicada] || 0) + 1;
    });

    const container = document.getElementById("vacinasPorTipo");
    container.innerHTML = "";

    Object.entries(agrupadas).forEach(([nome, qtd]) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<strong>${qtd}</strong><br>${nome}`;
      container.appendChild(card);
    });
  }

  /* ==========================
     INICIALIZAÇÃO
  ========================== */
  Promise.all([dadosAnimais, dadosEventos, dadosVacinas]).then(
    ([animais, eventos, vacinas]) => {

      calcularResumo(animais, eventos);
      calcularReproducao(animais, eventos);
      calcularPartos(eventos, 2025);
      calcularVacinas(vacinas, 2025);
    }
  );

});
</script>
