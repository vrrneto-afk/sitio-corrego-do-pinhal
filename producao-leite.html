<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Leite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS global jÃ¡ travado -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<main class="container">

  <h2>ðŸ¥› ProduÃ§Ã£o de Leite</h2>

  <!-- Filtro de perÃ­odo -->
  <select id="periodo">
    <option value="mensal">Mensal</option>
    <option value="bimestral">Bimestral</option>
    <option value="trimestral">Trimestral</option>
    <option value="semestral">Semestral</option>
    <option value="anual">Anual</option>
  </select>

  <!-- Cards -->
  <div class="cards">
    <div class="card">
      <strong id="cardLitros">0</strong>
      <span>Litros</span>
    </div>

    <div class="card">
      <strong id="cardPreco">R$ 0,00</strong>
      <span>PreÃ§o mÃ©dio</span>
    </div>

    <div class="card">
      <strong id="cardTotal">R$ 0,00</strong>
      <span>Total</span>
    </div>

    <div class="card">
      <strong id="cardMediaDia">0.00</strong>
      <span>MÃ©dia diÃ¡ria</span>
    </div>
  </div>

  <h3>ðŸ“’ Caderneta Mensal</h3>

  <!-- Filtros -->
  <select id="mes"></select>
  <select id="ano"></select>

  <!-- Tabela -->
  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Litros</th>
        <th>Valor do Dia</th>
        <th>Vacas</th>
        <th>MÃ©dia / Vaca</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr>
        <th>Total</th>
        <th id="tLitros">0</th>
        <th id="tValor">R$ 0,00</th>
        <th>-</th>
        <th id="tMedia">0.00</th>
      </tr>
    </tfoot>
  </table>

</main>

<script>
const API = "COLE_AQUI_SUA_URL_DO_APPS_SCRIPT";

const meses = [
  "Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho",
  "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
];

let rows = [];

function formatMoney(v){
  return "R$ " + v.toFixed(2).replace(".", ",");
}

function parseNumber(v){
  if(!v) return 0;
  return Number(String(v).replace(",", "."));
}

function parseDate(r){
  if(r.data_referencia){
    const p = r.data_referencia.split("/");
    if(p.length === 3){
      return new Date(p[2], p[1]-1, p[0]);
    }
  }
  return new Date(r.ano, r.mes-1, r.dia);
}

async function load(){
  const res = await fetch(API);
  const json = await res.json();
  rows = json.PRODUCAO_LEITE || [];

  rows.forEach(r=>{
    r.litros = parseNumber(r.litros_dia);
    r.preco = parseNumber(r.preco_litro);
    r.valorDia = r.litros * r.preco;
    r.mediaVaca = r.vacas_produzindo ? r.litros / r.vacas_produzindo : 0;
    r.date = parseDate(r);
  });

  const hoje = new Date();
  const mesAtual = hoje.getMonth()+1;
  const anoAtual = hoje.getFullYear();

  const anos = [...new Set(rows.map(r=>r.ano))].sort();
  const anoInicial = anos.includes(anoAtual) ? anoAtual : 2025;

  ano.innerHTML = anos.map(a=>`<option value="${a}">${a}</option>`).join("");
  ano.value = anoInicial;

  mes.innerHTML = meses.map((m,i)=>`<option value="${i+1}">${m}</option>`).join("");

  const mesesDisponiveis = rows.filter(r=>r.ano===anoInicial).map(r=>r.mes);
  mes.value = mesesDisponiveis.includes(mesAtual) ? mesAtual : 1;

  render();
}

function render(){
  const p = periodo.value;
  const m = Number(mes.value);
  const a = Number(ano.value);

  let base = rows.filter(r=>r.ano===a);

  if(p==="mensal") base = base.filter(r=>r.mes===m);
  if(p==="bimestral") base = base.filter(r=>r.mes>=m && r.mes<=m+1);
  if(p==="trimestral") base = base.filter(r=>r.mes>=m && r.mes<=m+2);
  if(p==="semestral") base = base.filter(r=>r.mes>=m && r.mes<=m+5);

  let litros = 0, total = 0, dias = new Set();

  base.forEach(r=>{
    litros += r.litros;
    total += r.valorDia;
    dias.add(r.date.toDateString());
  });

  const precoMedio = litros ? total / litros : 0;
  const mediaDia = dias.size ? litros / dias.size : 0;

  cardLitros.innerText = litros.toFixed(0);
  cardPreco.innerText = formatMoney(precoMedio);
  cardTotal.innerText = formatMoney(total);
  cardMediaDia.innerText = mediaDia.toFixed(2);

  const mensal = rows.filter(r=>r.ano===a && r.mes===m);

  tbody.innerHTML = "";
  let tLit = 0, tVal = 0, tMed = 0;

  mensal.forEach(r=>{
    tLit += r.litros;
    tVal += r.valorDia;
    tMed += r.mediaVaca;

    tbody.innerHTML += `
      <tr>
        <td>${r.date.toLocaleDateString("pt-BR")}</td>
        <td>${r.litros}</td>
        <td>${formatMoney(r.valorDia)}</td>
        <td>${r.vacas_produzindo}</td>
        <td>${r.mediaVaca.toFixed(2)}</td>
      </tr>`;
  });

  tLitros.innerText = tLit;
  tValor.innerText = formatMoney(tVal);
  tMedia.innerText = mensal.length ? (tMed/mensal.length).toFixed(2) : "0.00";
}

periodo.onchange = render;
mes.onchange = render;
ano.onchange = render;

load();
</script>

</body>
</html>
