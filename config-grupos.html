<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Grupos</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="menu-adm.css">
<link rel="stylesheet" href="config.css">

<style>
/* GRID PERMISS√ïES */
.permissoes-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px;
  margin-top:10px;
}

.perm-item{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  white-space:nowrap;
}

/* ===== MODAL MENSAGEM ===== */
.modal-msg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal-msg .box{
  background:#fff;
  padding:20px;
  border-radius:14px;
  max-width:320px;
  width:90%;
  text-align:center;
}

.modal-msg .box p{
  margin:0 0 16px;
  font-size:15px;
  font-weight:600;
  color:#5a3b2e;
}

.modal-msg .box button{
  padding:10px 18px;
  border:none;
  border-radius:10px;
  background:#2f6b2f;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
</style>
</head>

<body style="display:none">

<!-- MODAL -->
<div id="modalMsg" class="modal-msg">
  <div class="box">
    <p id="modalTexto"></p>
    <button onclick="fecharMensagem()">OK</button>
  </div>
</div>

<div id="app" class="hidden">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Configura√ß√£o ‚Äì Grupos de Acesso</h2>

<div class="cards-grid" id="lista-grupos"></div>

<div id="editor" class="hidden">
<fieldset>

<label>ID do grupo</label>
<input type="text" id="grupo_id">

<label>Nome do grupo</label>
<input type="text" id="grupo_nome">

<hr>

<h3>üì± App (visualiza√ß√£o)</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="inicio"><span>In√≠cio</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="tempo"><span>Tempo</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="lembretes"><span>Lembretes</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="animais"><span>Animais</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="vacas"><span>Vacas</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="bezerros"><span>Bezerros</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="historico"><span>Hist√≥rico</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="farmacia"><span>Farm√°cia</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="vacinas"><span>Vacinas</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="leite"><span>Leite</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="despesas"><span>Despesas</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="clima"><span>Clima</span></label>
</div>

<h4>üìä Relat√≥rios</h4>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="relatorio_financeiro"><span>Financeiro</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="relatorio_leite"><span>Produ√ß√£o de Leite</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="relatorio_rebanho"><span>Rebanho</span></label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="relatorio_sanitario"><span>Sanit√°rio</span></label>
</div>

<hr>

<h3>üßæ √Årea Administrativa</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="login"><span>Login</span></label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_animais"><span>Animais</span></label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_farmacia"><span>Farm√°cia</span></label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_vacinas"><span>Vacinas</span></label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_eventos"><span>Eventos</span></label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_leite"><span>Leite</span></label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_despesas"><span>Despesas</span></label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_fotos"><span>Fotos</span></label>
</div>

<hr>

<h3>‚öôÔ∏è Configura√ß√µes</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config"><span>Painel Config</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-geral"><span>Geral</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-bezerros"><span>Bezerros</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-vacinas"><span>Vacinas</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-vacas"><span>Vacas</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-leite"><span>Leite</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-despesas"><span>Despesas</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-especies"><span>Esp√©cies</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-farmacia"><span>Farm√°cia</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-clima"><span>Clima</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-menu"><span>Menu</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-grupos"><span>Grupos</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-usuarios"><span>Usu√°rios</span></label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="tudo"><span>Acesso total</span></label>
</div>

</fieldset>

<button class="salvar" onclick="salvarGrupo()">üíæ Salvar</button>
<button class="voltar" onclick="cancelar()">‚ùå Cancelar</button>

</div>

<button class="voltar" onclick="location.href='config.html'">
‚¨Ö Voltar para Configura√ß√µes
</button>

</div>
</div>

<script>
fetch("menu-adm.html").then(r=>r.text()).then(html=>{
  document.getElementById("menu-adm").innerHTML = html;
});

firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});

const auth = firebase.auth();
const db   = firebase.firestore();

let grupos = [];
let editando = null;

auth.onAuthStateChanged(user=>{
  if(user){
    document.body.style.display="block";
    document.getElementById("app").classList.remove("hidden");
    carregar();
  }
});

async function carregar(){
  const snap = await db.collection("config").doc("grupos").get();
  grupos = snap.exists ? snap.data().lista || [] : [];
  render();
}

function render(){
  const area = document.getElementById("lista-grupos");
  area.innerHTML="";

  grupos.forEach((g,i)=>{
    const b = document.createElement("button");
    b.className="config-card";
    b.innerHTML=`<strong>${g.nome}</strong><span>ID: ${g.id}</span>`;
    b.onclick=()=>editar(i);
    area.appendChild(b);
  });

  const novo = document.createElement("button");
  novo.className="config-card";
  novo.innerHTML="‚ûï Novo grupo";
  novo.onclick=novoGrupo;
  area.appendChild(novo);
}

function novoGrupo(){
  editando=null;
  grupo_id.value="";
  grupo_nome.value="";
  document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
  document.getElementById("editor").classList.remove("hidden");
}

function editar(i){
  editando=i;
  const g = grupos[i];

  grupo_id.value=g.id;
  grupo_nome.value=g.nome;

  document.querySelectorAll("input[type=checkbox]").forEach(c=>{
    const area=c.dataset.area;
    const pag=c.dataset.pagina;
    c.checked = g.permissoes?.[area]?.[pag] === true;
  });

  document.getElementById("editor").classList.remove("hidden");
}

async function salvarGrupo(){
  const id = grupo_id.value.trim();
  const nome = grupo_nome.value.trim();
  if(!id || !nome){
    mostrarMensagem("Informe o ID e o nome do grupo.");
    return;
  }

  const permissoes={};

  document.querySelectorAll("input[type=checkbox]").forEach(c=>{
    if(!c.checked) return;
    const area=c.dataset.area;
    const pag=c.dataset.pagina;
    permissoes[area] = permissoes[area] || {};
    permissoes[area][pag] = true;
  });

  const obj={ id, nome, permissoes };

  if(editando===null) grupos.push(obj);
  else grupos[editando]=obj;

  try{
    await db.collection("config").doc("grupos").set({ lista: grupos });
    mostrarMensagem("Configura√ß√µes salvas com sucesso.");
    cancelar();
    render();
  }catch(e){
    mostrarMensagem("Erro ao salvar as configura√ß√µes.");
  }
}

function cancelar(){
  document.getElementById("editor").classList.add("hidden");
  editando=null;
}

/* ===== MODAL ===== */
function mostrarMensagem(txt){
  document.getElementById("modalTexto").innerText = txt;
  document.getElementById("modalMsg").style.display="flex";
}

function fecharMensagem(){
  document.getElementById("modalMsg").style.display="none";
}
</script>

<script src="access-control.js"></script>
<script>
verificarAcesso("config","config-grupos");
</script>

<script src="auth-adm.js"></script>
</body>
</html>
