<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relat√≥rio de Rebanho ‚Äì S√≠tio C√≥rrego do Pinhal</title>

<link rel="stylesheet" href="menu.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#c0392b;
  --amarelo:#e0a800;
  --cinza:#666;
  --logo:#D0B485;
}

*{box-sizing:border-box;font-family:Inter,system-ui,Arial}
body{margin:0;background:var(--bege);color:#333}

header{background:var(--logo);padding:15px;text-align:center}
header img{max-width:260px;width:100%}

.container{max-width:900px;margin:20px auto;padding:0 15px}
h2,h3{color:var(--marrom)}

.filtros{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-bottom:14px
}
select{
  padding:12px;
  border-radius:12px;
  border:1.5px solid #ddd;
  background:#f2f2f2;
  font-size:15px
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-bottom:20px
}
.card{
  background:#fff;
  padding:14px;
  border-left:6px solid var(--verde);
  border-radius:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.05)
}
.card.alerta{border-left-color:var(--amarelo)}
.card.negativo{border-left-color:var(--vermelho)}
.card strong{font-size:22px;display:block}
.card span{font-size:14px;color:var(--cinza)}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:14px;
  overflow:hidden
}
th,td{
  padding:10px;
  border-bottom:1px solid #eee;
  font-size:14px;
  text-align:center
}
th{background:#efe3d3}
</style>
</head>

<body>

<header><img src="logo.png"></header>
<div id="menu"></div>

<div class="container">

<h2>üêæ Relat√≥rio de Rebanho</h2>

<div class="filtros">
  <select id="especie"></select>
  <select id="visao">
    <option value="geral">Vis√£o geral</option>
    <option value="anual">Vis√£o anual</option>
  </select>
</div>

<!-- RESUMO -->
<div class="cards">
  <div class="card"><strong id="cTotal">0</strong><span>Total de animais</span></div>
  <div class="card"><strong id="cAtivos">0</strong><span>Ativos</span></div>
  <div class="card"><strong id="cVendidos">0</strong><span>Vendidos / Doados</span></div>
  <div class="card negativo"><strong id="cFalecidos">0</strong><span>Falecidos</span></div>
</div>

<!-- ESTRUTURA -->
<h3>üß¨ Estrutura do rebanho</h3>
<div class="cards">
  <div class="card"><strong id="cMachos">0</strong><span>Machos</span></div>
  <div class="card"><strong id="cFemeas">0</strong><span>F√™meas</span></div>
  <div class="card"><strong id="cJovens">0</strong><span>Jovens</span></div>
  <div class="card"><strong id="cAdultos">0</strong><span>Adultos</span></div>
</div>

<!-- ALERTAS -->
<h3>üö® Alertas</h3>
<div class="cards">
  <div class="card alerta" id="cardAlerta">
    <strong id="alerta">Rebanho dentro do esperado</strong>
    <span id="alertaDesc">Monitoramento autom√°tico</span>
  </div>
</div>

<!-- TABELA -->
<h3>üìã Detalhamento</h3>
<table>
<thead>
<tr>
  <th>Nome</th>
  <th>Esp√©cie</th>
  <th>Sexo</th>
  <th>Idade</th>
  <th>Status</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>
fetch("menu.html").then(r=>r.text()).then(h=>menu.innerHTML=h);

firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});
const db=firebase.firestore();

let ANIMAIS=[];

function idade(data){
  if(!data) return 0;
  const d=new Date(data.seconds*1000);
  return Math.floor((Date.now()-d)/31557600000);
}

async function load(){
  ANIMAIS=(await db.collection("animais").get()).docs.map(d=>d.data());
  const especies=["Todas",...new Set(ANIMAIS.map(a=>a.especie).filter(Boolean))];
  especie.innerHTML=especies.map(e=>`<option>${e}</option>`).join("");
  especie.onchange=render;
  render();
}

function render(){
  const esp=especie.value;
  const dados=esp==="Todas"?ANIMAIS:ANIMAIS.filter(a=>a.especie===esp);

  const total=dados.length;
  const ativos=dados.filter(a=>a.status==="Ativo").length;
  const vendidos=dados.filter(a=>["Vendido","Doado"].includes(a.status)).length;
  const falecidos=dados.filter(a=>a.status==="Falecido").length;

  const machos=dados.filter(a=>a.sexo==="M").length;
  const femeas=dados.filter(a=>a.sexo==="F").length;
  const jovens=dados.filter(a=>idade(a.data_nascimento)<2).length;
  const adultos=dados.filter(a=>idade(a.data_nascimento)>=2).length;

  cTotal.innerText=total;
  cAtivos.innerText=ativos;
  cVendidos.innerText=vendidos;
  cFalecidos.innerText=falecidos;
  cMachos.innerText=machos;
  cFemeas.innerText=femeas;
  cJovens.innerText=jovens;
  cAdultos.innerText=adultos;

  /* ===== ALERTAS ===== */
  let texto="Rebanho dentro do esperado";
  let desc="Monitoramento autom√°tico";
  let classe="alerta";

  if(falecidos>0){
    texto="Aten√ß√£o: h√° registros de falecimento";
    desc="Verifique causas e hist√≥rico sanit√°rio";
    classe="negativo";
  }else if(total>0 && ativos/total<0.5){
    texto="Aten√ß√£o: poucos animais ativos";
    desc="Muitos animais sem produ√ß√£o ou fun√ß√£o";
    classe="negativo";
  }else if(total<5){
    texto="Rebanho muito reduzido";
    desc="Risco operacional elevado";
    classe="negativo";
  }else if(total>0 && (vendidos/total)>0.3){
    texto="Alerta: alta taxa de sa√≠da";
    desc="Vendas/doa√ß√µes acima do normal";
  }else if(total>0 && (jovens/total)<0.15){
    texto="Alerta: pouca reposi√ß√£o";
    desc="Rebanho envelhecendo";
  }else if(total>0 && (machos/total)>0.6){
    texto="Alerta: excesso de machos";
    desc="Pode impactar reprodu√ß√£o";
  }else if(total>0 && (femeas/total)>0.85){
    texto="Alerta: desequil√≠brio de f√™meas";
    desc="Avaliar manejo reprodutivo";
  }

  alerta.innerText=texto;
  alertaDesc.innerText=desc;
  cardAlerta.className="card "+classe;

  tbody.innerHTML="";
  dados.forEach(a=>{
    tbody.innerHTML+=`
      <tr>
        <td>${a.nome||"-"}</td>
        <td>${a.especie||"-"}</td>
        <td>${a.sexo||"-"}</td>
        <td>${idade(a.data_nascimento)} anos</td>
        <td>${a.status||"-"}</td>
      </tr>`;
  });
}

load();
</script>

</body>
</html>
