<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SÃ­tio CÃ³rrego do Pinhal</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7b3f2a">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#c0392b;
  --amarelo:#e0a800;
  --laranja:#e67e22;
  --cinza:#666;
  --logo:#D0B485;
}
*{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Arial,Helvetica,sans-serif}
body{margin:0;background:var(--bege);color:#333}

/* HEADER */
header{background:var(--logo);padding:15px 10px;text-align:center;position:relative}
header img{max-width:260px;width:100%}
.admin-icon{position:absolute;top:10px;right:10px}
.admin-icon img{width:32px;height:32px}

/* MENU */
nav{
  background:var(--marrom);
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:4px;
}
nav a{
  color:#fff;
  text-decoration:none;
  font-weight:600;
  font-size:15px;
  padding:12px 14px;
  border-radius:10px;
  display:flex;
  align-items:center;
  gap:6px;
  opacity:.85;
  position:relative;
  transition:.2s;
}
nav a span{font-size:18px}

/* HOVER */
nav a:hover{
  background:rgba(255,255,255,.12);
  opacity:1;
}

/* ITEM ATIVO */
nav a.ativo{
  background:rgba(255,255,255,.18);
  font-weight:800;
  opacity:1;
}
nav a.ativo::after{
  content:"";
  position:absolute;
  bottom:4px;
  left:15%;
  width:70%;
  height:3px;
  background:#fff;
  border-radius:10px;
}

/* CONTAINER */
.container{max-width:900px;margin:20px auto;padding:0 15px}
h2{margin:28px 0 12px;color:var(--marrom);font-size:20px}

/* CLIMA */
.clima-bar{background:#fff;margin:12px auto 16px;padding:10px 14px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.08);font-size:14px;color:#555;text-align:center}

/* ALERTA RÃPIDO */
.alerta-rapido{display:block;margin:0 auto 20px;padding:12px;border-radius:12px;font-weight:700;text-align:center;text-decoration:none;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.alerta-ok{background:#eaf6ec;color:var(--verde)}
.alerta-on{background:#fdecea;color:var(--vermelho)}

/* CARDS */
.card{background:#fff;padding:15px;margin-bottom:18px;border-left:6px solid var(--verde);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.card.ok{border-color:var(--verde)}
.card.atencao{border-color:var(--amarelo)}
.card.alerta{border-color:var(--laranja)}
.card.urgente{border-color:var(--vermelho)}
.card.atrasada{border-color:var(--vermelho)}
.card.pendente{border-color:var(--amarelo)}
.card strong{font-size:17px;font-weight:800;text-transform:uppercase}
.card p{margin:6px 0;color:var(--cinza)}
.highlight{font-weight:700}

/* OVERLAY */
#overlay-alerta{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
#banner-alerta{background:#fff;width:90%;max-width:520px;max-height:85vh;overflow-y:auto;padding:20px;border-radius:12px}
#banner-alerta h1{text-align:center;margin-bottom:15px;color:var(--marrom)}
.bloco{border:1.5px solid #ddd;border-radius:12px;padding:14px;margin-bottom:14px}
.bloco h3{margin:0 0 8px;color:var(--marrom)}
.item{padding:6px 0;border-bottom:1px solid #eee}
.item:last-child{border-bottom:none}
.vazio{color:#777;font-style:italic}
#fechar-alerta{margin-top:10px;width:100%;padding:12px;background:var(--marrom);color:#fff;border:none;border-radius:6px;font-size:16px}
</style>
</head>

<body>

<header>
  <img src="logo.png">
  <a href="cadastro_animais.html" class="admin-icon"><img src="icone-admin.png"></a>
</header>

<nav>
  <a href="index.html" class="ativo"><span>ğŸ </span> InÃ­cio</a>
  <a href="lembretes.html"><span>ğŸ“</span> Lembretes</a>
  <a href="animais.html"><span>ğŸ¾</span> Animais</a>
  <a href="vacas.html"><span>ğŸ„</span> Vacas</a>
  <a href="bezerros.html"><span>ğŸ®</span> Bezerros</a>
  <a href="historico.html"><span>ğŸ“œ</span> HistÃ³rico</a>
  <a href="farmacia.html"><span>ğŸ’Š</span> FarmÃ¡cia</a>
  <a href="vacinas.html"><span>ğŸ’‰</span> Vacinas</a>
  <a href="leite.html"><span>ğŸ¥›</span> Leite</a>
  <a href="despesas.html"><span>ğŸ’°</span> Despesas</a>
  <a href="relatorios.html"><span>ğŸ“Š</span> RelatÃ³rios</a>
</nav>

<div class="container">
  <div class="clima-bar" id="clima">â³ Carregando clima...</div>

  <a href="lembretes.html" id="alertaRapido" class="alerta-rapido alerta-ok">
    ğŸ”” Nenhum alerta no momento
  </a>

  <div id="conteudo"></div>
</div>

<div id="overlay-alerta">
  <div id="banner-alerta">
    <h1>ğŸš¨ ATENÃ‡ÃƒO DO DIA ğŸš¨</h1>
    <div id="alerta-conteudo"></div>
    <button id="fechar-alerta">Fechar</button>
  </div>
</div>

<script>  
firebase.initializeApp({  
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",  
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",  
  projectId:"sitio-corrego-do-pinhal"  
});  
const db=firebase.firestore();  
  
const hoje=new Date();  
const hojeZ=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate());  
  
function parse(d){if(!d||typeof d!=="string")return null;const p=d.split("-");return new Date(p[0],p[1]-1,p[2])}  
function addM(d,m){const x=new Date(d);x.setMonth(x.getMonth()+m);return x}  
function diff(a,b){return Math.floor((b-a)/86400000)}  
  
function classeCriacao(d){if(d>60)return"ok";if(d>30)return"atencao";if(d>15)return"alerta";return"urgente"}  
  
/* CLIMA */  
async function loadClima(){  
  try{  
    const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=-21.3127&longitude=-46.3721&current_weather=true&timezone=America/Sao_Paulo");  
    const d=await r.json();  
    const c=d.current_weather;  
    document.getElementById("clima").innerHTML=`â˜€ï¸ JurÃ©ia â€“ Monte Belo/MG â€¢ ${Math.round(c.temperature)}Â°C`;  
  }catch{  
    document.getElementById("clima").innerHTML="ğŸŒ¦ï¸ Clima indisponÃ­vel";  
  }  
}  
  
/* INDEX */  
async function loadIndex(){  
  const conteudo=document.getElementById("conteudo");  
  conteudo.innerHTML="";  
  
  const ani=(await db.collection("animais").get()).docs.map(d=>({_id:d.id,...d.data()}));  
  const eve=(await db.collection("eventos").get()).docs.map(d=>d.data());  
  const vac=(await db.collection("vacinas").get()).docs.map(d=>d.data());  
  
  conteudo.innerHTML+="<h2>ğŸ„ Vacas a Criar</h2>";  
  
  eve.filter(e=>e.tipo_evento==="cobertura").map(c=>{  
    const prev=addM(parse(c.data_evento),9);  
    return {v:ani.find(a=>a._id===c.id_animal),prev};  
  }).filter(x=>x.v).sort((a,b)=>a.prev-b.prev).forEach(v=>{  
    const dias=diff(hojeZ,v.prev);  
    let cls=classeCriacao(dias), aviso="";  
    if(dias<0){aviso=` ğŸš¨ Passou ${Math.abs(dias)} dias da data prevista.`;cls="urgente";}  
    else if(dias<=15)aviso=" ğŸš¨ Urgente";  
    else if(dias<=30)aviso=" âš ï¸ AtenÃ§Ã£o";  
    else if(dias<=60)aviso=" âš ï¸ Desmamar";  
  
    conteudo.innerHTML+=`  
      <div class="card ${cls}">  
        <strong>ğŸ„ ${v.v.nome}</strong>  
        <p>PrevisÃ£o: ${v.prev.toLocaleDateString("pt-BR")}</p>  
        <p class="highlight">â³ Faltam ${dias} dias${aviso}</p>  
      </div>`;  
  });  
  
  conteudo.innerHTML+="<h2>ğŸ’‰ Vacinas pendentes</h2>";  
  
  vac.forEach(v=>{  
    if(v.status==="Finalizada"||!v.data_aplicacao||Number(v.repeticao_dias)<=0)return;  
    const reap=new Date(parse(v.data_aplicacao));  
    reap.setDate(reap.getDate()+Number(v.repeticao_dias));  
    const dias=diff(hojeZ,reap);  
    let texto=dias===0?"ğŸš¨ Aplicar hoje.":dias<0?`âš ï¸ Atrasada hÃ¡ ${Math.abs(dias)} dias`:`â³ Reaplicar em ${dias} dias`;  
  
    conteudo.innerHTML+=`  
      <div class="card ${dias<0?"atrasada":"pendente"}">  
        <strong>ğŸ’‰ ${v.nome_vacina}</strong>  
        <p>${texto}</p>  
        <p>ğŸ“… ${reap.toLocaleDateString("pt-BR")}</p>  
      </div>`;  
  });  
}  
  
/* BANNER */  
async function loadBanner(){  
  const ani=(await db.collection("animais").get()).docs.map(d=>({_id:d.id,...d.data()}));  
  const eve=(await db.collection("eventos").get()).docs.map(d=>d.data());  
  const vac=(await db.collection("vacinas").get()).docs.map(d=>d.data());  
  const lem=(await db.collection("lembretes").get()).docs.map(d=>d.data());  
  
  const box=document.getElementById("alerta-conteudo");  
  const overlay=document.getElementById("overlay-alerta");  
  const alertaRapido=document.getElementById("alertaRapido");  
  
  box.innerHTML="";  
  let totalAlertas=0;  
  
  /* ğŸ“ LEMBRETES */  
  if(lem.length){  
    totalAlertas+=lem.length;  
    box.innerHTML+=`  
      <div class="bloco">  
        <h3>ğŸ“ LEMBRETES</h3>  
        ${lem.map(l=>`<div class="item">${l.texto}</div>`).join("")}  
      </div>`;  
  }  
  
  /* ğŸ’‰ VACINAS */  
  const vacAlertas=vac.filter(v=>{  
    if(v.status==="Finalizada"||!v.data_aplicacao||Number(v.repeticao_dias)<=0)return false;  
    const reap=new Date(parse(v.data_aplicacao));  
    reap.setDate(reap.getDate()+Number(v.repeticao_dias));  
    return diff(hojeZ,reap)<=0;  
  });  
  
  if(vacAlertas.length){  
    totalAlertas+=vacAlertas.length;  
    box.innerHTML+=`  
      <div class="bloco">  
        <h3>ğŸ’‰ VACINAS</h3>  
        ${vacAlertas.map(v=>{  
  const a = ani.find(x=>x._id===v.id_animal);  
  return `<div class="item">ğŸ’‰ ${v.nome_vacina} â€” ğŸ„ ${(a?.nome||"-").toUpperCase()}</div>`;  
}).join("")}  
      </div>`;  
  }  
  
  /* ğŸ„ CRIAS */  
  const crias=eve.filter(e=>e.tipo_evento==="cobertura")  
    .map(c=>{  
      const prev=addM(parse(c.data_evento),9);  
      return {  
        v:ani.find(a=>a._id===c.id_animal),  
        dias:diff(hojeZ,prev)  
      };  
    })  
    .filter(x=>x.v && x.dias<=15);  
  
  if(crias.length){  
    totalAlertas+=crias.length;  
    box.innerHTML+=`  
      <div class="bloco">  
        <h3>ğŸ„ CRIAS</h3>  
        ${crias.map(c=>`  
          <div class="item">  
            ${c.v.nome} â€“ ${  
              c.dias<0  
                ? `ğŸš¨ atrasada ${Math.abs(c.dias)} dias`  
                : `faltam ${c.dias} dias`  
            }  
          </div>`).join("")}  
      </div>`;  
  }  
  
  if(totalAlertas>0){  
    overlay.style.display="flex";  
    alertaRapido.className="alerta-rapido alerta-on";  
    alertaRapido.innerHTML=`ğŸš¨ ${totalAlertas} alertas pendentes`;  
  }else{  
    overlay.style.display="none";  
    alertaRapido.className="alerta-rapido alerta-ok";  
    alertaRapido.innerHTML="ğŸ”” Nenhum alerta no momento";  
  }  
}  
  
/* FECHAR */  
document.getElementById("fechar-alerta").onclick=()=>{  
  document.getElementById("overlay-alerta").style.display="none";  
};  
  
loadClima();  
loadIndex();  
loadBanner();  
</script> 
  
</body>  
</html>
