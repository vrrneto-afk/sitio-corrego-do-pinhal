<script>
const API_URL="https://script.google.com/macros/s/AKfycbxizkZt7pvNE-otYQe0sqtjYBUx3iI8QA13Di6Cv4hq2YgaosafGzYx2XBf71CxK0QzfQ/exec";

function toObj(sheet){
  const h=sheet[0];
  return sheet.slice(1).filter(r=>r[0]).map(r=>{
    let o={}; h.forEach((k,i)=>o[k]=r[i]); return o;
  });
}

function addMonths(d,m){
  const x=new Date(d);
  x.setMonth(x.getMonth()+m);
  return x;
}

function parseDate(v){
  if(!v) return null;
  const d=new Date(v);
  return isNaN(d)?null:d;
}

async function carregarDados(){
  const conteudo=document.getElementById("conteudo");
  conteudo.innerHTML="<p style='color:#666'>Carregando...</p>";

  const d=await (await fetch(API_URL)).json();

  const ANIMAIS=toObj(d.ANIMAIS);
  const EVENTOS=toObj(d.EVENTOS);
  const VACINAS=toObj(d.VACINAS);

  const hoje=new Date();

  /* ================= VACAS A CRIAR ================= */
  conteudo.innerHTML="<h2>ğŸ„ Vacas a Criar</h2>";

  const partos=EVENTOS.filter(e=>e.tipo_evento==="parto");

  const vacasCriar = EVENTOS
    .filter(e=>e.tipo_evento==="cobertura")
    .map(c=>{
      const vaca=ANIMAIS.find(a=>a.id_animal===c.id_animal && a.status==="Ativo");
      if(!vaca) return null;

      const jaPariu = partos.some(p =>
        p.id_animal===c.id_animal &&
        new Date(p.data_evento)>new Date(c.data_evento)
      );
      if(jaPariu) return null;

      const prev=addMonths(new Date(c.data_evento),9);
      const dias=Math.ceil((prev-hoje)/86400000);
      if(dias<0) return null;

      return {vaca, cobertura:c.data_evento, prev, dias};
    })
    .filter(Boolean)
    .sort((a,b)=>a.dias-b.dias);

  if(!vacasCriar.length){
    conteudo.innerHTML+="<p style='color:#666'>Nenhuma vaca a criar.</p>";
  }

  vacasCriar.forEach(v=>{
    conteudo.innerHTML+=`
      <div class="card">
        <strong>ğŸ„ ${v.vaca.nome}</strong>
        <p>Cobertura: ${new Date(v.cobertura).toLocaleDateString()}</p>
        <p>PrevisÃ£o: ${v.prev.toLocaleDateString()}</p>
        <p class="highlight">â³ Faltam ${v.dias} dias</p>
      </div>`;
  });

  /* ================= VACINAS ================= */
  conteudo.innerHTML+="<h2>ğŸ’‰ Vacinas</h2>";

  const vacinasPendentes = VACINAS
    .filter(v=>v.status!=="Finalizada")
    .map(v=>{
      const animal=ANIMAIS.find(a=>a.id_animal===v.id_animal && a.status==="Ativo");
      if(!animal) return null;

      const prox=parseDate(v.data_proxima_dose);
      if(!prox) return null;

      const dias=Math.ceil((prox-hoje)/86400000);

      return {...v, animal, prox, dias};
    })
    .filter(Boolean)
    .sort((a,b)=>{
      if(a.dias<0 && b.dias>=0) return -1;
      if(a.dias>=0 && b.dias<0) return 1;
      return a.dias-b.dias;
    });

  if(!vacinasPendentes.length){
    conteudo.innerHTML+="<p style='color:#666'>Nenhuma vacina pendente.</p>";
  }

  vacinasPendentes.forEach(v=>{
    conteudo.innerHTML+=`
      <div class="card">
        <strong>ğŸ’‰ ${v.vacina_aplicada}</strong>
        <p>ğŸ„ ${v.animal.nome}</p>
        <p class="highlight">
          ${v.dias<0
            ?`âš ï¸ Atrasada hÃ¡ ${Math.abs(v.dias)} dias`
            :`â° Reaplicar em ${v.dias} dias`}
        </p>
        <p>ğŸ“… ${v.prox.toLocaleDateString()}</p>
      </div>`;
  });
}

carregarDados();
</script>
