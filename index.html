<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S√≠tio C√≥rrego do Pinhal</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --vinho:#7A1E2C;
  --bege-claro:#F3E6CC;
}
body{
  margin:0;
  font-family:Montserrat,Arial;
  background:#fff;
  color:#333;
}
header{
  text-align:center;
  padding:15px;
  border-bottom:1px solid #ddd;
}
nav{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:10px;
  background:var(--vinho);
  flex-wrap:wrap;
}
nav button{
  background:none;
  color:#fff;
  border:none;
  font-size:14px;
  cursor:pointer;
}
.page{
  display:none;
  padding:15px;
}
.page.active{display:block}
footer{
  text-align:center;
  padding:8px;
  font-size:13px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:13px;
  vertical-align:top;
}
th{
  background:var(--bege-claro);
}
th button{
  background:none;
  border:none;
  font-weight:600;
  cursor:pointer;
}
.card{
  border-left:4px solid var(--vinho);
  padding:8px;
  margin-bottom:6px;
  background:#fafafa;
}
button.small{
  font-size:12px;
  padding:3px 6px;
}
</style>
</head>

<body>

<header>
  <h2>S√çTIO C√ìRREGO DO PINHAL</h2>
  <div>Fam√≠lia Ribeiro</div>
  <div id="dataHoje"></div>
</header>

<nav>
  <button onclick="abrir('home')">In√≠cio</button>
  <button onclick="abrir('vacas')">Vacas</button>
  <button onclick="abrir('crias')">Crias</button>
  <button onclick="abrir('historico')">Hist√≥rico de Crias</button>
</nav>

<footer>
  <span onclick="login()" style="cursor:pointer">‚öôÔ∏è Administrador</span>
</footer>

<section id="home" class="page active">
  <h3>Vacas a Criar</h3>
  <div id="homeLista"></div>
</section>

<section id="vacas" class="page">
  <h3>Vacas</h3>
  <table id="tVacas"></table>
</section>

<section id="crias" class="page">
  <h3>Crias (Gesta√ß√£o Atual)</h3>
  <table id="tCrias"></table>
</section>

<section id="historico" class="page">
  <h3>Hist√≥rico de Crias</h3>
  <table id="tHistorico"></table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let dados=[];
let admin=false;
let sort={campo:null,dir:1};

const data=d=>new Date(d.split("/").reverse().join("-"));

window.login=async()=>{
  const email=prompt("Email admin");
  const senha=prompt("Senha");
  try{
    await signInWithEmailAndPassword(auth,email,senha);
    admin=true;
    montarTudo();
    alert("Administrador ativo");
  }catch{alert("Login inv√°lido")}
};

window.abrir=id=>{
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

document.getElementById("dataHoje").innerText=
  "Data atual: "+new Date().toLocaleDateString("pt-BR");

function ordenar(lista){
  if(!sort.campo) return lista;
  return [...lista].sort((a,b)=>{
    let x=a[sort.campo]||"", y=b[sort.campo]||"";
    if(sort.campo.includes("Em")||sort.campo.includes("Dia")){
      return sort.dir*(data(x)-data(y));
    }
    return sort.dir*x.localeCompare(y);
  });
}

function setSort(c){
  sort.dir = sort.campo===c ? -sort.dir : 1;
  sort.campo=c;
  montarTudo();
}

async function carregar(){
  const snap=await getDocs(collection(db,"vacas"));
  dados=snap.docs.map(d=>({id:d.id,...d.data()}));
  montarTudo();
}

function montarHome(){
  const h=document.getElementById("homeLista");
  h.innerHTML="";
  dados.filter(d=>!d.criouDia&&d.criaEm)
    .sort((a,b)=>data(a.criaEm)-data(b.criaEm))
    .forEach(d=>{
      const dias=Math.ceil((data(d.criaEm)-new Date())/86400000);
      h.innerHTML+=`
        <div class="card">
          <strong>${d.nome}</strong> ‚Äì ${d.touro||"-"} ‚Äì ${d.criaEm} ‚Äì faltam ${dias} dias
        </div>`;
    });
}

function montarVacas(){
  let l=ordenar(dados);
  let h=`
  <tr>
    <th><button onclick="setSort('nome')">Nome</button></th>
    <th><button onclick="setSort('raca')">Ra√ßa</button></th>
    <th><button onclick="setSort('touro')">Touro</button></th>
    <th><button onclick="setSort('panhou')">Panhou cria</button></th>
    <th><button onclick="setSort('criaEm')">Parto previsto</button></th>
    ${admin?"<th>A√ß√µes</th>":""}
  </tr>`;
  l.forEach(d=>{
    h+=`
    <tr>
      <td>${d.nome||""}</td>
      <td>${d.raca||""}</td>
      <td>${d.touro||""}</td>
      <td>${d.panhou||""}</td>
      <td>${d.criaEm||""}</td>
      ${admin?`
      <td>
        <button class="small" onclick="editar('${d.id}')">‚úèÔ∏è</button>
        <button class="small" onclick="excluir('${d.id}')">üóëÔ∏è</button>
      </td>`:""}
    </tr>`;
  });
  document.getElementById("tVacas").innerHTML=h;
}

function montarCrias(){
  let l=ordenar(dados.filter(d=>!d.criouDia));
  let h=`
  <tr>
    <th><button onclick="setSort('nome')">Vaca</button></th>
    <th><button onclick="setSort('touro')">Touro</button></th>
    <th><button onclick="setSort('panhou')">Panhou cria</button></th>
    <th><button onclick="setSort('criaEm')">Parto previsto</button></th>
  </tr>`;
  l.forEach(d=>{
    h+=`
    <tr>
      <td>${d.nome}</td>
      <td>${d.touro||""}</td>
      <td>${d.panhou||""}</td>
      <td>${d.criaEm||""}</td>
    </tr>`;
  });
  document.getElementById("tCrias").innerHTML=h;
}

function montarHistorico(){
  let l=ordenar(dados.filter(d=>d.criouDia));
  let h=`
  <tr>
    <th><button onclick="setSort('nome')">Vaca</button></th>
    <th><button onclick="setSort('touro')">Touro</button></th>
    <th><button onclick="setSort('criouDia')">Data do parto</button></th>
    <th><button onclick="setSort('nomeCria')">Nome da cria</button></th>
    ${admin?"<th>A√ß√µes</th>":""}
  </tr>`;
  l.forEach(d=>{
    h+=`
    <tr>
      <td>${d.nome}</td>
      <td>${d.touro||""}</td>
      <td>${d.criouDia}</td>
      <td>${d.nomeCria}</td>
      ${admin?`
      <td>
        <button class="small" onclick="editarHistorico('${d.id}')">‚úèÔ∏è</button>
        <button class="small" onclick="excluir('${d.id}')">üóëÔ∏è</button>
      </td>`:""}
    </tr>`;
  });
  document.getElementById("tHistorico").innerHTML=h;
}

window.editar=async id=>{
  const d=dados.find(x=>x.id===id);
  await updateDoc(doc(db,"vacas",id),{
    touro:prompt("Touro",d.touro||""),
    panhou:prompt("Panhou cria",d.panhou||""),
    criaEm:prompt("Parto previsto",d.criaEm||"")
  });
  carregar();
};

window.editarHistorico=async id=>{
  const d=dados.find(x=>x.id===id);
  await updateDoc(doc(db,"vacas",id),{
    touro:prompt("Touro",d.touro||""),
    criouDia:prompt("Data do parto",d.criouDia||""),
    nomeCria:prompt("Nome da cria",d.nomeCria||"")
  });
  carregar();
};

window.excluir=async id=>{
  if(confirm("Excluir registro?")){
    await deleteDoc(doc(db,"vacas",id));
    carregar();
  }
};

function montarTudo(){
  montarHome();
  montarVacas();
  montarCrias();
  montarHistorico();
}

carregar();
</script>

</body>
</html>
