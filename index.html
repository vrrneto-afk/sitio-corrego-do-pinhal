<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SÃ­tio CÃ³rrego do Pinhal</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7b3f2a">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* (CSS INALTERADO â€” exatamente como vocÃª enviou) */
</style>
</head>

<body>

<header>
  <img src="logo.png">
  <a href="login.html" class="admin-icon">
    <img src="icone-admin.png">
  </a>
</header>

<div id="menu"></div>

<div class="container">
  <div class="clima-bar" id="clima">â³ Carregando clima...</div>

  <a href="lembretes.html" id="alertaRapido" class="alerta-rapido alerta-ok">
    ğŸ”” Nenhum alerta no momento
  </a>

  <div id="conteudo"></div>
</div>

<!-- MODAL CLIMA -->
<div id="modalClima">
  <div class="box">
    <h3>ğŸŒ¦ï¸ PrevisÃ£o do Tempo</h3>
    <div id="climaDetalhado"></div>
    <button class="fechar" onclick="modalClima.style.display='none'">Fechar</button>
  </div>
</div>

<script>
/* ğŸ”´ CORREÃ‡ÃƒO CRÃTICA: REFERÃŠNCIAS DOM */
const menu = document.getElementById("menu");
const clima = document.getElementById("clima");
const climaDetalhado = document.getElementById("climaDetalhado");
const modalClima = document.getElementById("modalClima");
const alertaRapido = document.getElementById("alertaRapido");
const conteudo = document.getElementById("conteudo");

/* MENU */
fetch("menu.html").then(r=>r.text()).then(h=>{
  menu.innerHTML = h;
  document.querySelectorAll("#menu a").forEach(a=>{
    if(a.getAttribute("href")==="index.html") a.classList.add("ativo");
  });
});

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});
const db = firebase.firestore();

/* DATAS */
const hoje = new Date();
const hojeZ = new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate());
const diasSemana = ["DOM","SEG","TER","QUA","QUI","SEX","SÃB"];

function parse(d){
  if(!d) return null;
  const p=d.split("-");
  return new Date(p[0],p[1]-1,p[2]);
}
function addM(d,m){ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; }
function diff(a,b){ return Math.floor((b-a)/86400000); }
function classeCriacao(d){
  if(d>60)return"ok";
  if(d>30)return"atencao";
  if(d>15)return"alerta";
  return"urgente";
}

/* CLIMA */
let climaDados=null;

async function loadClima(){
  try{
    const r = await fetch(
      "https://api.open-meteo.com/v1/forecast?latitude=-21.3127&longitude=-46.3721&current_weather=true&daily=temperature_2m_min,temperature_2m_max,precipitation_probability_mean,precipitation_sum&timezone=America/Sao_Paulo"
    );
    climaDados = await r.json();
    clima.innerHTML = `â˜€ï¸ JurÃ©ia â€“ Monte Belo/MG â€¢ ${Math.round(climaDados.current_weather.temperature)}Â°C`;
  }catch{
    clima.innerHTML="ğŸŒ¦ï¸ Clima indisponÃ­vel";
  }
}

clima.onclick = ()=>{
  if(!climaDados) return;
  climaDetalhado.innerHTML="";
  for(let i=0;i<5;i++){
    const d = new Date(climaDados.daily.time[i]);
    climaDetalhado.innerHTML += `
      <div class="clima-dia">
        <span>${diasSemana[d.getDay()]}</span>
        <span>${climaDados.daily.precipitation_probability_mean[i]}% â€¢ ${climaDados.daily.precipitation_sum[i]||0} mm</span>
        <span>${Math.round(climaDados.daily.temperature_2m_min[i])}Â° mÃ­n / ${Math.round(climaDados.daily.temperature_2m_max[i])}Â° mÃ¡x</span>
      </div>`;
  }
  modalClima.style.display="flex";
};

/* ALERTAS */
async function loadAlertas(){
  const snap = await db.collection("lembretes").get();
  alertaRapido.className = snap.size ? "alerta-rapido alerta-on" : "alerta-rapido alerta-ok";
  alertaRapido.innerText = snap.size
    ? `ğŸ”” ${snap.size} itens pendentes para comprar`
    : "ğŸ”” Nenhum alerta no momento";
}

/* INDEX */
async function loadIndex(){
  conteudo.innerHTML = "";

  const ani = (await db.collection("animais").get()).docs.map(d=>({_id:d.id,...d.data()}));
  const eve = (await db.collection("eventos").get()).docs.map(d=>d.data());
  const vac = (await db.collection("vacinas").get()).docs.map(d=>d.data());

  conteudo.innerHTML += "<h2>ğŸ„ Vacas a Criar</h2>";

  eve.filter(e=>e.tipo_evento==="cobertura")
    .map(c=>{
      const prev = addM(parse(c.data_evento),9);
      return {v:ani.find(a=>a._id===c.id_animal),prev,dias:diff(hojeZ,prev)};
    })
    .filter(x=>x.v)
    .sort((a,b)=>a.dias-b.dias)
    .forEach(v=>{
      conteudo.innerHTML += `
        <div class="card ${classeCriacao(v.dias)}">
          <strong>ğŸ„ ${v.v.nome}</strong>
          <p class="dias">â³ Faltam ${v.dias} dias</p>
          <p class="data">PrevisÃ£o: ${v.prev.toLocaleDateString("pt-BR")}</p>
        </div>`;
    });

  conteudo.innerHTML += "<h2>ğŸ’‰ Vacinas pendentes</h2>";

  vac.forEach(v=>{
    if(v.status==="Finalizada"||!v.data_aplicacao||Number(v.repeticao_dias)<=0)return;
    const reap = new Date(parse(v.data_aplicacao));
    reap.setDate(reap.getDate()+Number(v.repeticao_dias));
    const dias = diff(hojeZ,reap);
    const a = ani.find(x=>x._id===v.id_animal);

    conteudo.innerHTML += `
      <div class="card ${dias<0?"atrasada":"pendente"}">
        <strong>ğŸ’‰ ${v.nome_vacina}</strong>
        <p class="dias">${dias<0?`âš ï¸ Atrasada hÃ¡ ${Math.abs(dias)} dias`:`â³ Reaplicar em ${dias} dias`}</p>
        <p class="data">ğŸ„ ${(a?.nome||"-").toUpperCase()}</p>
        <p class="data">ğŸ“… ${reap.toLocaleDateString("pt-BR")}</p>
      </div>`;
  });
}

loadClima();
loadAlertas();
loadIndex();
</script>

</body>
</html>
