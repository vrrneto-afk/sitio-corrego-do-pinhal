<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxizkZt7pvNE-otYQe0sqtjYBUx3iI8QA13Di6Cv4hq2YgaosafGzYx2XBf71CxK0QzfQ/exec";

function sheetToObjects(sheet) {
  const headers = sheet[0];
  return sheet.slice(1).filter(r => r[0]).map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });
}

async function carregarDados() {
  const resp = await fetch(API_URL);
  const data = await resp.json();

  const ANIMAIS = sheetToObjects(data.ANIMAIS);
  const EVENTOS = sheetToObjects(data.EVENTOS);
  const VACINAS = sheetToObjects(data.VACINAS);
  const CONFIG  = sheetToObjects(data.CONFIG);

  const gestacao = Number(
    CONFIG.find(c => c.chave === "gestacao_bovino_dias")?.valor || 280
  );

  const hoje = new Date();
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = "<h2>ğŸ„ Vacas a Criar</h2>";

  /* ===== VACAS ===== */
  EVENTOS.filter(e => e.tipo_evento === "cobertura").forEach(ev => {
    const vaca = ANIMAIS.find(a => a.id_animal === ev.id_animal);
    if (!vaca || vaca.status !== "Ativo") return;

    const dataCob = new Date(ev.data_evento);
    const partoPrev = new Date(dataCob);
    partoPrev.setDate(partoPrev.getDate() + gestacao);

    const dias = Math.ceil((partoPrev - hoje) / 86400000);

    conteudo.innerHTML += `
      <div class="card">
        <strong>ğŸ„ ${vaca.nome}</strong>
        <p>Cobertura: ${dataCob.toLocaleDateString()}</p>
        <p>PrevisÃ£o: ${partoPrev.toLocaleDateString()}</p>
        <p class="highlight">â³ Faltam ${dias} dias</p>
      </div>
    `;
  });

  /* ===== VACINAS ===== */
  conteudo.innerHTML += "<h2>ğŸ’‰ Vacinas</h2>";

  VACINAS.forEach(v => {
    const animal = ANIMAIS.find(a => a.id_animal === v.id_animal);
    if (!animal || animal.status !== "Ativo") return;

    const prox = new Date(v.data_proxima_dose);
    const diff = Math.ceil((prox - hoje) / 86400000);

    const texto =
      diff >= 0
        ? `â° Reaplicar em ${diff} dias`
        : `âš ï¸ Atrasada em ${Math.abs(diff)} dias`;

    conteudo.innerHTML += `
      <div class="card">
        <strong>ğŸ’‰ ${v.vacina_aplicada}</strong>
        <p>ğŸ„ ${animal.nome}</p>
        <p class="highlight">${texto}</p>
        <p>ğŸ“… ${prox.toLocaleDateString()}</p>
      </div>
    `;
  });
}

carregarDados();
</script>
