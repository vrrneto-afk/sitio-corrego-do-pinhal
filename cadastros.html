<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Animais</title>

<!-- üî• Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#f6efe7;
  margin:0;
  padding:20px;
}
h2{color:#7b3f2a}

select,input,textarea,button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  font-size:14px;
}

button{
  background:#7b3f2a;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:hover{opacity:.9}

.foto-preview{
  text-align:center;
  margin-bottom:10px;
}
.foto-preview img{
  max-width:100%;
  max-height:220px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}

.msg{
  padding:10px;
  margin-top:10px;
  font-weight:bold;
}
.ok{background:#d4edda;color:#155724}
.err{background:#f8d7da;color:#721c24}
</style>
</head>

<body>

<h2>üêæ Cadastro de Animais</h2>

<select id="modo">
  <option value="novo">‚ûï Cadastrar novo</option>
  <option value="editar">‚úèÔ∏è Editar animal</option>
  <option value="excluir">üóëÔ∏è Excluir animal</option>
</select>

<select id="listaAnimais" style="display:none"></select>

<div class="foto-preview" id="fotoPreview"></div>

<input id="nome" placeholder="Nome do animal">
<input id="especie" placeholder="Esp√©cie (ex: Bovino)">
<select id="sexo">
  <option value="">Sexo</option>
  <option value="M">Macho</option>
  <option value="F">F√™mea</option>
</select>
<input id="raca" placeholder="Ra√ßa">
<input id="data_nascimento" type="date">
<select id="status">
  <option value="Ativo">Ativo</option>
  <option value="Inativo">Inativo</option>
</select>
<input id="id_mae" placeholder="ID da m√£e (opcional)">
<input id="id_pai" placeholder="ID do pai (opcional)">
<textarea id="observacoes" placeholder="Observa√ß√µes"></textarea>

<input type="file" id="foto" accept="image/*">

<button id="salvar">Salvar</button>

<div id="mensagem"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
  projectId: "sitio-corrego-do-pinhal",
  storageBucket: "sitio-corrego-do-pinhal.firebasestorage.app"
});

const db = firebase.firestore();
const storage = firebase.storage();

const modo = document.getElementById("modo");
const lista = document.getElementById("listaAnimais");
const msg = document.getElementById("mensagem");
const fotoPreview = document.getElementById("fotoPreview");

let animais = [];
let animalAtual = null;

async function carregarAnimais(){
  const snap = await db.collection("animais").orderBy("nome").get();
  animais = snap.docs.map(d=>d.data());
  lista.innerHTML = "<option value=''>Selecione</option>" +
    animais.map(a=>`<option value="${a.id_animal}">${a.nome}</option>`).join("");
}

modo.onchange = ()=>{
  lista.style.display = modo.value==="novo" ? "none" : "block";
  limpar();
};

lista.onchange = ()=>{
  animalAtual = animais.find(a=>a.id_animal===lista.value);
  if(!animalAtual) return;
  preencher(animalAtual);
};

function preencher(a){
  nome.value=a.nome||"";
  especie.value=a.especie||"";
  sexo.value=a.sexo||"";
  raca.value=a.raca||"";
  data_nascimento.value=a.data_nascimento||"";
  status.value=a.status||"Ativo";
  id_mae.value=a.id_mae||"";
  id_pai.value=a.id_pai||"";
  observacoes.value=a.observacoes||"";
  fotoPreview.innerHTML = a.foto ? `<img src="${a.foto}">` : "";
}

function limpar(){
  animalAtual=null;
  document.querySelectorAll("input,textarea,select").forEach(i=>{
    if(i.id!=="modo") i.value="";
  });
  fotoPreview.innerHTML="";
  msg.innerHTML="";
}

async function uploadFoto(id){
  const file = foto.files[0];
  if(!file) return animalAtual?.foto || "";
  const ref = storage.ref(`animais/${id}.jpg`);
  await ref.put(file);
  return await ref.getDownloadURL();
}

salvar.onclick = async ()=>{
  try{
    if(modo.value==="excluir"){
      if(!animalAtual) return;
      await db.collection("animais").doc(animalAtual.id_animal).delete();
      msg.innerHTML="<div class='msg ok'>Animal exclu√≠do</div>";
      await carregarAnimais();
      limpar();
      return;
    }

    const id = animalAtual?.id_animal || Date.now().toString();
    const fotoUrl = await uploadFoto(id);

    const dados = {
      id_animal:id,
      nome:nome.value,
      especie:especie.value,
      sexo:sexo.value,
      raca:raca.value,
      data_nascimento:data_nascimento.value,
      status:status.value,
      id_mae:id_mae.value,
      id_pai:id_pai.value,
      observacoes:observacoes.value,
      foto:fotoUrl,
      criado_em: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("animais").doc(id).set(dados);
    msg.innerHTML="<div class='msg ok'>Animal salvo com sucesso</div>";
    await carregarAnimais();
  }catch(e){
    msg.innerHTML="<div class='msg err'>Erro ao salvar</div>";
  }
};

carregarAnimais();
</script>

</body>
</html>
