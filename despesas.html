<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
  projectId: "sitio-corrego-do-pinhal",
  storageBucket: "sitio-corrego-do-pinhal.firebasestorage.app",
  messagingSenderId: "327649698102",
  appId: "1:327649698102:web:6018468836ed7cfd319397"
};

initializeApp(firebaseConfig);
const db=getFirestore();

const meses=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const num=v=>Number(v)||0;

let rows=[];

async function load(){
  const snap=await getDocs(collection(db,"despesas"));
  rows=snap.docs.map(d=>d.data());

  mes.innerHTML=meses.map((m,i)=>`<option value="${i+1}">${m}</option>`).join("");
  ano.innerHTML=[...new Set(rows.map(r=>r.ano))].sort().map(a=>`<option>${a}</option>`).join("");

  mes.value=1;
  ano.value=2025;

  periodo.onchange=renderResumo;
  mes.onchange=()=>{renderResumo();renderTabela();};
  ano.onchange=()=>{renderResumo();renderTabela();};

  renderVencimentos();
  renderResumo();
  renderTabela();
}

function renderVencimentos(){
  const hoje=new Date();
  vencimentos.innerHTML="";

  rows.forEach(r=>{
    if(r.status_pagamento==="Pago"||!r.data_vencimento) return;

    const d=new Date(r.data_vencimento);
    const dias=Math.ceil((d-hoje)/86400000);

    vencimentos.innerHTML+=`
    <div class="card ${dias<0?"atrasada":""}">
      <strong>${r.fornecedor}</strong>
      <p>${r.nome_despesa}</p>
      <p class="${dias>=0?"highlight":"atraso"}">
        ${dias>=0?`‚è≥ Vence em ${dias} dias`:`‚ö†Ô∏è Atrasada h√° ${Math.abs(dias)} dias`}
      </p>
      <p>üí∞ ${moeda(r.valor_total)}</p>
      <p>üìÖ ${d.toLocaleDateString("pt-BR")}</p>
    </div>`;
  });

  if(!vencimentos.innerHTML){
    vencimentos.innerHTML=`
    <div class="card">
      <strong>‚úî Nenhuma despesa pendente</strong>
      <p>Todas as despesas est√£o pagas.</p>
    </div>`;
  }
}

function renderResumo(){
  const m=+mes.value,a=+ano.value,p=periodo.value;
  let inicio=m;
  if(p==="bimestral") inicio=m-1;
  if(p==="trimestral") inicio=m-2;
  if(p==="semestral") inicio=m-5;
  if(p==="anual") inicio=1;
  if(inicio<1) inicio=1;

  const base=rows.filter(r=>r.ano===a&&r.mes>=inicio&&r.mes<=m);
  const total=base.reduce((s,r)=>s+num(r.valor_total),0);

  totalDespesas.innerText=moeda(total);
  qtdDespesas.innerText=base.length;
  mediaDespesa.innerText=moeda(base.length?total/base.length:0);
}

function renderTabela(){
  const m=+mes.value,a=+ano.value;
  const f=rows.filter(r=>r.mes===m&&r.ano===a);

  let total=0;
  tbody.innerHTML="";

  f.forEach(r=>{
    total+=num(r.valor_total);
    tbody.innerHTML+=`
    <tr>
      <td class="col-data">${String(r.dia).padStart(2,"0")}/${String(m).padStart(2,"0")}/${a}</td>
      <td class="col-texto">${r.tipo_despesa}</td>
      <td class="col-texto">${r.fornecedor}</td>
      <td class="col-valor">${moeda(r.valor_total)}</td>
    </tr>`;
  });

  tValor.innerText=moeda(total);
}

load();
</script>
