<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Menu</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="menu-adm.css">
<link rel="stylesheet" href="config.css">

<style>
.check-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:12px;
  font-weight:600;
}
.check-row input{margin:0;}
</style>
</head>

<body style="display:none">

<div id="app" class="hidden">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Configura√ß√£o ‚Äì Menu</h2>

<div class="cards-grid" id="lista-menu"></div>

<!-- EDITOR -->
<div id="editor" class="hidden">
<fieldset>

<label>ID do menu (fixo)</label>
<input type="text" id="menu_id">

<label>T√≠tulo exibido</label>
<input type="text" id="menu_titulo">

<label>√çcone (emoji)</label>
<input type="text" id="menu_icone" placeholder="Ex: üè† üêÑ üìä">

<label>Ordem</label>
<input type="number" id="menu_ordem" min="1">

<div class="check-row">
  <input type="checkbox" id="menu_ativo" checked>
  <label for="menu_ativo">Item ativo</label>
</div>

</fieldset>

<button class="salvar" onclick="salvarItem()">üíæ Salvar</button>

<button class="voltar" id="btnExcluir" onclick="excluirItem()" style="background:#b03a2e;color:#fff">
üóë Excluir item
</button>

<button class="voltar" onclick="cancelarEdicao()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">
‚¨Ö Voltar para Configura√ß√µes
</button>

</div>
</div>

<script>
/* MENU ADM */
fetch("menu-adm.html")
.then(r=>r.text())
.then(html=>{
  document.getElementById("menu-adm").innerHTML = html;
});

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});

const db = firebase.firestore();

/* ESTADO */
let itens = [];
let editando = null;

/* LIBERAR TELA */
document.body.style.display="block";
document.getElementById("app").classList.remove("hidden");

carregar();

/* LOAD */
async function carregar(){
  const snap = await db.collection("config").doc("menu").get();
  if(!snap.exists) return;

  itens = snap.data().itens || [];
  itens.sort((a,b)=>(a.ordem||0)-(b.ordem||0));
  renderizar();
}

/* RENDER */
function renderizar(){
  const area = document.getElementById("lista-menu");
  area.innerHTML = "";

  itens.forEach((m,i)=>{
    const b = document.createElement("button");
    b.className="config-card";
    b.onclick = ()=>editarItem(i);

    if(m.ativo === false) b.style.opacity="0.5";

    b.innerHTML = `
      <strong>${m.icone || "üìÅ"} ${m.titulo}</strong>
      <span>ID: ${m.id} ‚Ä¢ Ordem: ${m.ordem}${m.ativo===false?" ‚Ä¢ Inativo":""}</span>
    `;
    area.appendChild(b);
  });

  /* NOVO ITEM */
  const novo = document.createElement("button");
  novo.className="config-card";
  novo.innerHTML="‚ûï Novo item de menu";
  novo.onclick=novoItem;
  area.appendChild(novo);
}

/* NOVO */
function novoItem(){
  editando = null;
  limparFormulario();
  document.getElementById("btnExcluir").style.display="none";
  document.getElementById("editor").classList.remove("hidden");
}

/* EDITAR */
function editarItem(i){
  editando = i;
  const m = itens[i];

  menu_id.value     = m.id || "";
  menu_titulo.value = m.titulo || "";
  menu_icone.value  = m.icone || "";
  menu_ordem.value  = m.ordem || "";
  menu_ativo.checked = m.ativo !== false;

  document.getElementById("btnExcluir").style.display="block";
  document.getElementById("editor").classList.remove("hidden");
}

/* SALVAR */
async function salvarItem(){
  const obj = {
    id: menu_id.value.trim(),
    titulo: menu_titulo.value.trim(),
    icone: menu_icone.value.trim(),
    ordem: Number(menu_ordem.value),
    ativo: menu_ativo.checked
  };

  if(!obj.id || !obj.titulo){
    alert("Informe o ID e o t√≠tulo.");
    return;
  }

  if(editando === null) itens.push(obj);
  else itens[editando] = obj;

  await db.collection("config").doc("menu").update({ itens });

  alert("Item salvo com sucesso.");
  cancelarEdicao();
  renderizar();
}

/* EXCLUIR */
async function excluirItem(){
  if(editando === null) return;
  if(!confirm("Deseja excluir este item do menu?")) return;

  itens.splice(editando,1);
  await db.collection("config").doc("menu").update({ itens });

  alert("Item exclu√≠do com sucesso.");
  cancelarEdicao();
  renderizar();
}

/* CANCELAR */
function cancelarEdicao(){
  document.getElementById("editor").classList.add("hidden");
  limparFormulario();
  editando = null;
}

/* LIMPAR */
function limparFormulario(){
  menu_id.value="";
  menu_titulo.value="";
  menu_icone.value="";
  menu_ordem.value="";
  menu_ativo.checked=true;
}
</script>

<script src="auth-guard.js"></script>
<script src="auth-adm.js"></script>

</body>
</html>
