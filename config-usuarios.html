<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Usu√°rios</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="menu-adm.css">
<link rel="stylesheet" href="config.css">

<style>
.check-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:600;
}
.check-row input{margin:0;}
.small{font-size:13px;opacity:.7;}
.actions{display:flex;gap:10px;margin-top:14px;}
.actions button{flex:1;}
.danger{background:#b03a2e !important;}
</style>
</head>

<body style="display:none">

<div id="app" class="hidden">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Configura√ß√£o ‚Äì Usu√°rios</h2>

<div class="cards-grid" id="lista-usuarios"></div>

<button class="config-card" onclick="novoUsuario()">‚ûï Criar usu√°rio</button>

<div id="editor" class="hidden">
<fieldset>

<label>Nome</label>
<input type="text" id="user_nome">

<label>Usu√°rio (login)</label>
<input type="text" id="user_usuario">

<label>Email</label>
<input type="email" id="user_email">

<label>Grupo</label>
<select id="user_grupo"></select>

<div class="check-row">
  <input type="checkbox" id="user_ativo">
  <label for="user_ativo">Usu√°rio ativo</label>
</div>

<p class="small">
‚úî Usu√°rios inativos n√£o acessam o sistema.<br>
‚ùå Usu√°rios exclu√≠dos perdem acesso definitivamente.
</p>

</fieldset>

<div class="actions">
  <button class="salvar" onclick="salvarUsuario()">üíæ Salvar</button>
  <button class="salvar" onclick="enviarEmail()">üìß Enviar acesso</button>
</div>

<button class="voltar danger" onclick="excluirUsuario()">üóë Excluir usu√°rio</button>
<button class="voltar" onclick="cancelarEdicao()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">
‚¨Ö Voltar para Configura√ß√µes
</button>

</div>
</div>

<script>
/* ===== MENU ADM ===== */
fetch("menu-adm.html")
  .then(r=>r.text())
  .then(html=>{
    document.getElementById("menu-adm").innerHTML = html;
  });

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});

const auth = firebase.auth();
const db   = firebase.firestore();

/* ===== ESTADO ===== */
let usuarios = [];
let grupos   = [];
let editando = null;

/* ===== AUTH ===== */
auth.onAuthStateChanged(user=>{
  if(user){
    document.body.style.display="block";
    document.getElementById("app").classList.remove("hidden");
    carregar();
  }
});

/* ===== LOAD ===== */
async function carregar(){
  const usnap = await db.collection("config").doc("usuarios").get();
  const gsnap = await db.collection("config").doc("grupos").get();

  usuarios = usnap.exists ? (usnap.data().lista || []) : [];
  grupos   = gsnap.exists ? (gsnap.data().lista || []) : [];

  renderUsuarios();
  preencherGrupos();
}

/* ===== RENDER ===== */
function renderUsuarios(){
  const area = document.getElementById("lista-usuarios");
  area.innerHTML = "";

  usuarios.forEach((u,i)=>{
    if(u.excluido) return;

    const b = document.createElement("button");
    b.className = "config-card";
    if(u.ativo === false) b.style.opacity = "0.5";

    b.onclick = ()=>editarUsuario(i);
    b.innerHTML = `
      <strong>üë§ ${u.nome}</strong>
      <span>${u.usuario} ‚Ä¢ ${u.email}</span>
    `;
    area.appendChild(b);
  });
}

/* ===== GRUPOS ===== */
function preencherGrupos(){
  const sel = document.getElementById("user_grupo");
  sel.innerHTML = "";

  grupos.forEach(g=>{
    const o = document.createElement("option");
    o.value = g.id;
    o.textContent = g.nome;
    sel.appendChild(o);
  });
}

/* ===== NOVO ===== */
function novoUsuario(){
  editando = null;
  user_nome.value = "";
  user_usuario.value = "";
  user_email.value = "";
  user_ativo.checked = true;
  editor.classList.remove("hidden");
}

/* ===== EDITAR ===== */
function editarUsuario(i){
  editando = i;
  const u = usuarios[i];

  user_nome.value = u.nome || "";
  user_usuario.value = u.usuario || "";
  user_email.value = u.email || "";
  user_grupo.value = u.grupo || "";
  user_ativo.checked = u.ativo === true;

  editor.classList.remove("hidden");
}

/* ===== SALVAR ===== */
async function salvarUsuario(){
  try{
    const nome    = user_nome.value.trim();
    const usuario = user_usuario.value.trim().toLowerCase();
    const email   = user_email.value.trim().toLowerCase();
    const grupo   = user_grupo.value;
    const ativo   = user_ativo.checked;

    if(!nome || !usuario || !email){
      alert("Preencha todos os campos.");
      return;
    }

    const obj = {
      nome,
      usuario,
      email,
      grupo,
      ativo,
      excluido: false
    };

    /* 1Ô∏è‚É£ Salva / atualiza lista de usu√°rios */
    if(editando === null){
      usuarios.push(obj);
    }else{
      Object.assign(usuarios[editando], obj);
    }

    await db.collection("config").doc("usuarios").set(
      { lista: usuarios },
      { merge: true }
    );

    /* 2Ô∏è‚É£ ATUALIZA LOGIN_MAP AUTOMATICAMENTE */
    if(ativo){
      await db.collection("config").doc("login_map").set(
        { [usuario]: email },
        { merge: true }
      );
    }

    alert("Usu√°rio salvo com sucesso.");
    cancelarEdicao();
    renderUsuarios();

  }catch(e){
    console.error("ERRO AO SALVAR:", e);
    alert("Erro ao salvar usu√°rio.");
  }
}

/* ===== EMAIL ===== */
async function enviarEmail(){
  const email = user_email.value.trim();
  if(!email) return alert("Email inv√°lido.");

  await auth.sendPasswordResetEmail(email);
  alert("E-mail de acesso enviado.");
}

/* ===== EXCLUIR ===== */
async function excluirUsuario(){
  if(editando === null) return;
  if(!confirm("Excluir definitivamente este usu√°rio?")) return;

  usuarios[editando].excluido = true;
  usuarios[editando].ativo = false;

  await db.collection("config").doc("usuarios").set({
    lista: usuarios
  });

  alert("Usu√°rio exclu√≠do.");
  cancelarEdicao();
  renderUsuarios();
}

/* ===== CANCELAR ===== */
function cancelarEdicao(){
  editor.classList.add("hidden");
  editando = null;
}
</script>

<script src="auth-adm.js"></script>
</body>
</html>
