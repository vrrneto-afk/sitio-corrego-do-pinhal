<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Usu√°rios</title>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="menu-adm.css">
<link rel="stylesheet" href="config.css">

<style>
.check-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:600;
}
.actions{display:flex;gap:10px;margin-top:14px;}
.actions button{flex:1;}
.danger{background:#b03a2e !important;}
</style>
</head>

<body style="display:none">

<script>
  /* üîê SOMENTE ADMIN */
  window.PERMISSAO_MINIMA = "admin";
</script>
<script src="auth-guard.js"></script>

<div id="app" class="hidden">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Configura√ß√£o ‚Äì Usu√°rios</h2>

<div class="cards-grid" id="lista-usuarios"></div>

<button class="config-card" onclick="novoUsuario()">‚ûï Criar usu√°rio</button>

<div id="editor" class="hidden">
<fieldset>

<label>Nome</label>
<input type="text" id="user_nome">

<label>Email</label>
<input type="email" id="user_email">

<label>Papel</label>
<select id="user_papel">
  <option value="admin">Administrador</option>
  <option value="operador">Operador</option>
  <option value="leitura">Somente leitura</option>
</select>

<div class="check-row">
  <input type="checkbox" id="user_ativo">
  <label for="user_ativo">Usu√°rio ativo</label>
</div>

</fieldset>

<div class="actions">
  <button onclick="salvarUsuario()">üíæ Salvar</button>
  <button onclick="enviarEmail()">üìß Enviar acesso</button>
</div>

<button class="voltar danger" onclick="desativarUsuario()">üö´ Desativar usu√°rio</button>
<button class="voltar" onclick="cancelar()">‚ùå Cancelar</button>

</div>

<button class="voltar" onclick="location.href='config.html'">
‚¨Ö Voltar para Configura√ß√µes
</button>

</div>
</div>

<script>
/* ===== FIREBASE INIT ===== */
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});

const auth = firebase.auth();
const db   = firebase.firestore();

let usuarios = [];
let editando = null;

/* ===== MENU ===== */
fetch("menu-adm.html")
  .then(r=>r.text())
  .then(html=>menu-adm.innerHTML = html);

/* ===== AUTH ===== */
auth.onAuthStateChanged(user=>{
  if(user){
    document.body.style.display = "block";
    app.classList.remove("hidden");
    carregarUsuarios();
  }
});

/* ===== LOAD ===== */
async function carregarUsuarios(){
  const snap = await db.collection("usuarios").orderBy("nome").get();
  usuarios = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  render();
}

/* ===== RENDER ===== */
function render(){
  const area = document.getElementById("lista-usuarios");
  area.innerHTML = "";

  usuarios.forEach((u)=>{
    const b = document.createElement("button");
    b.className = "config-card";
    if(!u.ativo) b.style.opacity = .5;

    b.innerHTML = `<strong>üë§ ${u.nome}</strong>
                   <span>${u.email} ‚Ä¢ ${u.papel}</span>`;
    b.onclick = ()=>editar(u.id);
    area.appendChild(b);
  });
}

/* ===== NOVO ===== */
window.novoUsuario = function(){
  editando = null;
  user_nome.value = "";
  user_email.value = "";
  user_papel.value = "operador";
  user_ativo.checked = true;
  editor.classList.remove("hidden");
}

/* ===== EDITAR ===== */
function editar(id){
  const u = usuarios.find(x=>x.id===id);
  editando = id;

  user_nome.value = u.nome;
  user_email.value = u.email;
  user_papel.value = u.papel;
  user_ativo.checked = u.ativo;

  editor.classList.remove("hidden");
}

/* ===== SALVAR ===== */
window.salvarUsuario = async function(){
  const nome  = user_nome.value.trim();
  const email = user_email.value.trim().toLowerCase();
  const papel = user_papel.value;
  const ativo = user_ativo.checked;

  if(!nome || !email){
    alert("Preencha todos os campos.");
    return;
  }

  try{
    if(editando === null){
      const senhaTemp = Math.random().toString(36).slice(-8);
      const cred = await auth.createUserWithEmailAndPassword(email, senhaTemp);

      await db.collection("usuarios").doc(cred.user.uid).set({
        nome, email, papel, ativo,
        criado_em: firebase.firestore.FieldValue.serverTimestamp(),
        ultimo_login: null
      });
    }else{
      await db.collection("usuarios").doc(editando).update({
        nome, papel, ativo
      });
    }

    alert("Usu√°rio salvo.");
    cancelar();
    carregarUsuarios();

  }catch(e){
    console.error(e);
    alert("Erro ao salvar usu√°rio.");
  }
}

/* ===== EMAIL ===== */
window.enviarEmail = async function(){
  const email = user_email.value.trim();
  if(!email) return;
  await auth.sendPasswordResetEmail(email);
  alert("Email enviado.");
}

/* ===== DESATIVAR ===== */
window.desativarUsuario = async function(){
  if(!editando) return;
  if(!confirm("Desativar este usu√°rio?")) return;

  await db.collection("usuarios").doc(editando).update({
    ativo:false
  });

  alert("Usu√°rio desativado.");
  cancelar();
  carregarUsuarios();
}

/* ===== CANCELAR ===== */
window.cancelar = function(){
  editor.classList.add("hidden");
  editando = null;
}
</script>

</body>
</html>
