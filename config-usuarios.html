<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ConfiguraÃ§Ã£o â€“ UsuÃ¡rios</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="menu-adm.css">
<link rel="stylesheet" href="config.css">

<style>
.check-row{display:flex;gap:10px;margin-top:12px;font-weight:600;}
.actions{display:flex;gap:10px;margin-top:14px;}
.actions button{flex:1;}
.danger{background:#b03a2e!important;}
</style>
</head>

<body style="display:none">

<script>
window.PERMISSAO_MINIMA="admin";
</script>
<script src="auth-guard.js"></script>

<div id="app" class="hidden">

<header>âš™ï¸ ConfiguraÃ§Ãµes</header>
<div id="menu-adm"></div>

<div class="container">
<h2>ConfiguraÃ§Ã£o â€“ UsuÃ¡rios</h2>

<div class="cards-grid" id="lista-usuarios"></div>
<button class="config-card" onclick="novoUsuario()">â• Criar usuÃ¡rio</button>

<div id="editor" class="hidden">
<fieldset>

<label>Nome</label>
<input type="text" id="user_nome">

<label>Email</label>
<input type="email" id="user_email">

<label>Papel</label>
<select id="user_papel">
  <option value="admin">Administrador</option>
  <option value="operador">Operador</option>
  <option value="leitura">Somente leitura</option>
</select>

<div class="check-row">
  <input type="checkbox" id="user_ativo">
  <label>UsuÃ¡rio ativo</label>
</div>

</fieldset>

<div class="actions">
  <button onclick="salvarUsuario()">ğŸ’¾ Salvar</button>
  <button onclick="enviarEmail()">ğŸ“§ Enviar acesso</button>
</div>

<button class="voltar danger" onclick="desativarUsuario()">ğŸš« Desativar usuÃ¡rio</button>
<button class="voltar" onclick="cancelar()">âŒ Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">â¬… Voltar</button>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});

const auth = firebase.auth();
const db = firebase.firestore();

let usuarios=[], editando=null;

fetch("menu-adm.html").then(r=>r.text()).then(h=>menu-adm.innerHTML=h);

auth.onAuthStateChanged(u=>{
  if(u){
    document.body.style.display="block";
    app.classList.remove("hidden");
    carregar();
  }
});

async function carregar(){
  const snap = await db.collection("usuarios").orderBy("nome").get();
  usuarios = snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
}

function render(){
  lista-usuarios.innerHTML="";
  usuarios.forEach(u=>{
    const b=document.createElement("button");
    b.className="config-card";
    if(!u.ativo) b.style.opacity=.5;
    b.innerHTML=`<strong>${u.nome}</strong><span>${u.email} â€¢ ${u.papel}</span>`;
    b.onclick=()=>editar(u.id);
    lista-usuarios.appendChild(b);
  });
}

function editar(id){
  const u=usuarios.find(x=>x.id===id);
  editando=id;
  user_nome.value=u.nome;
  user_email.value=u.email;
  user_papel.value=u.papel;
  user_ativo.checked=u.ativo;
  editor.classList.remove("hidden");
}

window.novoUsuario=()=>{
  editando=null;
  user_nome.value="";
  user_email.value="";
  user_papel.value="operador";
  user_ativo.checked=true;
  editor.classList.remove("hidden");
};

window.salvarUsuario=async()=>{
  const nome=user_nome.value.trim();
  const email=user_email.value.trim().toLowerCase();
  const papel=user_papel.value;
  const ativo=user_ativo.checked;

  if(!nome||!email) return alert("Preencha os campos.");

  if(editando===null){
    await db.collection("usuarios").add({
      nome,email,papel,ativo,pendente:true,
      criado_em:firebase.firestore.FieldValue.serverTimestamp(),
      ultimo_login:null
    });
  }else{
    await db.collection("usuarios").doc(editando).update({nome,papel,ativo});
  }

  cancelar();
  carregar();
};

window.enviarEmail=async()=>{
  const email=user_email.value.trim();
  if(email) await auth.sendPasswordResetEmail(email);
};

window.desativarUsuario=async()=>{
  if(editando){
    await db.collection("usuarios").doc(editando).update({ativo:false});
    cancelar();carregar();
  }
};

window.cancelar=()=>{
  editor.classList.add("hidden");
  editando=null;
};
</script>

</body>
</html>
