<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vacinas ‚Äì S√≠tio C√≥rrego do Pinhal</title>

<!-- MENU CSS -->
<link rel="stylesheet" href="menu.css">

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#c0392b;
  --amarelo:#e0a800;
  --cinza:#666;
  --logo:#D0B485;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial}
body{margin:0;background:var(--bege);color:#333}
header{background:var(--logo);padding:15px;text-align:center}
header img{max-width:260px;width:100%}

.container{max-width:900px;margin:20px auto;padding:0 15px}
h2{margin:25px 0;color:var(--marrom)}

select{
  width:100%;
  padding:12px;
  margin-bottom:20px;
  border-radius:10px;
  border:1.5px solid #ddd;
}

.card{
  background:#fff;
  padding:16px;
  margin-bottom:14px;
  border-left:6px solid var(--cinza);
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
  cursor:pointer;
}
.card.atrasada{border-color:var(--vermelho)}
.card.pendente{border-color:var(--amarelo)}
.card.finalizada{border-color:var(--verde)}

.card p{
  margin:5px 0;
  font-size:14px;
  color:var(--cinza);
}

.badge{
  display:inline-block;
  margin:6px 0;
  padding:4px 10px;
  font-size:12px;
  font-weight:700;
  color:#fff;
  border-radius:8px;
}
.atrasada-b{background:var(--vermelho)}
.pendente-b{background:var(--amarelo)}
.finalizada-b{background:var(--verde)}

.vazio{
  text-align:center;
  color:#777;
  font-style:italic;
  margin-top:30px;
}
</style>
</head>

<body>

<header>
  <img src="logo.png">
</header>

<!-- MENU -->
<div id="menu"></div>

<div class="container">
  <h2>üíâ Vacinas</h2>

  <select id="filtro">
    <option value="todas">Hist√≥rico completo</option>
    <option value="atrasada">Atrasadas</option>
    <option value="pendente">Pendentes</option>
    <option value="finalizada">Finalizadas</option>
  </select>

  <div id="lista"></div>
</div>

<!-- MENU LOAD -->
<script>
fetch("menu.html")
  .then(r=>r.text())
  .then(html=>{
    menu.innerHTML = html;
    document.querySelectorAll("#menu a").forEach(a=>{
      if(a.getAttribute("href")==="vacinas.html"){
        a.classList.add("ativo");
      }
    });
  });
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});
const db = getFirestore(app);

const hoje = new Date();
hoje.setHours(0,0,0,0);

function parseDate(v){
  if(v?.seconds) return new Date(v.seconds*1000);
  if(typeof v==="string") return new Date(v+"T00:00:00");
  return new Date(v);
}

function diffDias(a,b){
  return Math.ceil((b-a)/86400000);
}

async function load(){
  const snap = await getDocs(collection(db,"vacinas"));
  const VACINAS = snap.docs.map(d=>d.data());
  const lista = document.getElementById("lista");

  function render(filtro){
    lista.innerHTML="";
    let cards=[];

    VACINAS.forEach(v=>{
      const aplicada = parseDate(v.data_aplicacao);
      const repeticao = Number(v.repeticao_dias||0);

      let status, classe, badge, texto, grupo, ordem;

      if(v.status==="Finalizada"){
        status="finalizada";
        classe="finalizada";
        badge='<span class="badge finalizada-b">Finalizada</span>';
        grupo=3;
        ordem=aplicada;
      }else{
        const reaplicar = new Date(aplicada);
        reaplicar.setDate(reaplicar.getDate()+repeticao);
        const dias = diffDias(hoje,reaplicar);

        if(dias<0){
          status="atrasada";
          classe="atrasada";
          badge='<span class="badge atrasada-b">Atrasada</span>';
          texto=`‚ö†Ô∏è Atrasada h√° ${Math.abs(dias)} dias`;
          grupo=1;
          ordem=dias;
        }else{
          status="pendente";
          classe="pendente";
          badge='<span class="badge pendente-b">Pendente</span>';
          texto=`‚è≥ Reaplicar em ${dias} dias`;
          grupo=2;
          ordem=dias;
        }
      }

      if(filtro!=="todas" && filtro!==status) return;

      cards.push({
        grupo,
        ordem,
        html:`
        <div class="card ${classe}" onclick="location.href='animal.html?id=${v.id_animal}'">
          <strong>üíâ ${v.nome_vacina||"Vacina"}</strong>
          <p>üêÑ ${(v.nome_animal||"-").toUpperCase()}</p>
          ${badge}
          ${texto?`<p>${texto}</p>`:""}
          <p>Aplicada em: ${aplicada.toLocaleDateString("pt-BR")}</p>
        </div>`
      });
    });

    cards
      .sort((a,b)=>a.grupo-b.grupo || a.ordem-b.ordem)
      .forEach(c=>lista.innerHTML+=c.html);

    if(!cards.length){
      lista.innerHTML=`<div class="vazio">üíâ Nenhuma vacina encontrada.</div>`;
    }
  }

  filtro.onchange=e=>render(e.target.value);
  render("todas");
}

load();
</script>

</body>
</html>
