<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vacas – Sítio Córrego do Pinhal</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Montserrat',Arial,sans-serif;background:#fff;color:#333}
header{text-align:center;padding:15px;border-bottom:1px solid #ddd}
nav{background:#7A1E2C;display:flex;flex-wrap:wrap;justify-content:center;gap:12px;padding:10px}
nav a{color:#fff;text-decoration:none;font-size:14px}
nav a.active{text-decoration:underline}
main{padding:15px;max-width:1200px;margin:auto}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;font-size:14px}
th{background:#f3e6cc;cursor:pointer}
.admin-only{display:none}
body.admin .admin-only{display:inline-block}
button{background:#7A1E2C;color:#fff;border:none;border-radius:5px;padding:6px 10px;cursor:pointer}
button:hover{background:#5e1622}
.form-box{margin-bottom:15px}
.form-box input{padding:6px;margin:3px}
.admin-link{font-size:12px;color:#666;cursor:pointer}
@media(max-width:700px){
  th,td{font-size:12px}
}
</style>
</head>

<body>

<header>
  <h2>SÍTIO CÓRREGO DO PINHAL</h2>
  <div>Família Ribeiro</div>
  <div id="dataHoje"></div>
</header>

<nav>
  <a href="index.html">Início</a>
  <a href="vacas.html" class="active">Vacas</a>
  <a href="historico.html">Histórico de Crias</a>
  <a href="bezerros.html">Bezerros(as)</a>
  <a href="vacinacao.html">Vacinação</a>
</nav>

<div style="text-align:center;margin-top:8px">
  <span class="admin-link" onclick="loginAdmin()">⚙️ administrador</span>
</div>

<main>

<h3>Vacas</h3>

<div class="form-box admin-only">
  <input id="nome" placeholder="Nome">
  <input id="raca" placeholder="Raça">
  <input id="touro" placeholder="Touro">
  <input id="panhou" type="date">
  <button onclick="salvar()">Salvar</button>
</div>

<table id="tabela">
<thead>
<tr>
  <th onclick="ordenar('nome')">Nome</th>
  <th onclick="ordenar('raca')">Raça</th>
  <th onclick="ordenar('touro')">Touro</th>
  <th onclick="ordenar('panhou')">Panhou cria</th>
  <th onclick="ordenar('cria')">Cria em</th>
  <th class="admin-only">Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
  projectId: "sitio-corrego-do-pinhal",
  storageBucket: "sitio-corrego-do-pinhal.firebasestorage.app",
  messagingSenderId: "327649698102",
  appId: "1:327649698102:web:6018468836ed7cfd319397"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const col = collection(db,"vacas");

let dados = [];
let editId = null;
let ordem = {};

/* DATA ATUAL */
document.getElementById("dataHoje").innerText =
  "Data atual: " + new Date().toLocaleDateString("pt-BR");

/* LOGIN */
window.loginAdmin = function(){
  const u = prompt("Usuário");
  const s = prompt("Senha");
  if(u === "Venício" && s === "13231525"){
    document.body.classList.add("admin");
    alert("Modo administrador ativo");
  }
};

/* FORMATA DATA */
function fmt(d){
  if(!d) return "";
  if(d.includes("-")){
    const [a,m,di] = d.split("-");
    return `${di}/${m}/${a}`;
  }
  return d;
}

/* SOMA 9 MESES (SIMBÓLICO) */
function soma9(data){
  if(!data) return "";
  let dia,mes,ano;

  if(data.includes("-")){
    [ano,mes,dia] = data.split("-");
  }else{
    [dia,mes,ano] = data.split("/");
  }

  mes = parseInt(mes) + 9;
  ano = parseInt(ano);

  if(mes > 12){
    mes -= 12;
    ano++;
  }

  return `${String(dia).padStart(2,"0")}/${String(mes).padStart(2,"0")}/${ano}`;
}

/* DATA PARA ORDENAÇÃO */
function dataOrdenavel(valor){
  if(!valor) return "00000000";
  if(valor.includes("/")){
    const [d,m,a] = valor.split("/");
    return a + m.padStart(2,"0") + d.padStart(2,"0");
  }
  if(valor.includes("-")){
    const [a,m,d] = valor.split("-");
    return a + m.padStart(2,"0") + d.padStart(2,"0");
  }
  return "00000000";
}

/* CARREGAR */
async function carregar(){
  const snap = await getDocs(col);
  dados = [];
  snap.forEach(d => dados.push({id:d.id, ...d.data()}));
  render();
}

/* RENDER */
function render(){
  const tb = document.querySelector("#tabela tbody");
  tb.innerHTML = "";

  dados.forEach(d=>{
    const cria = d.cria || soma9(d.panhou);
    tb.innerHTML += `
      <tr>
        <td>${d.nome||""}</td>
        <td>${d.raca||""}</td>
        <td>${d.touro||""}</td>
        <td>${fmt(d.panhou)}</td>
        <td>${cria}</td>
        <td class="admin-only">
          <button onclick="editar('${d.id}')">Editar</button>
          <button onclick="excluir('${d.id}')">Excluir</button>
        </td>
      </tr>`;
  });
}

/* ORDENAÇÃO CORRETA */
window.ordenar = function(campo){
  ordem[campo] = !ordem[campo];
  const asc = ordem[campo];

  dados.sort((a,b)=>{
    let v1 = a[campo] || "";
    let v2 = b[campo] || "";

    if(campo === "panhou" || campo === "cria"){
      v1 = dataOrdenavel(v1);
      v2 = dataOrdenavel(v2);
    }else{
      v1 = v1.toString().toUpperCase();
      v2 = v2.toString().toUpperCase();
    }

    if(v1 < v2) return asc ? -1 : 1;
    if(v1 > v2) return asc ? 1 : -1;
    return 0;
  });

  render();
};

/* SALVAR */
window.salvar = async function(){
  const panhou = panhouInp.value;
  const cria = soma9(panhou);

  const obj = {
    nome: nomeInp.value,
    raca: racaInp.value,
    touro: touroInp.value,
    panhou,
    cria
  };

  if(editId){
    await updateDoc(doc(db,"vacas",editId),obj);
    editId = null;
  }else{
    await addDoc(col,obj);
  }

  nomeInp.value = racaInp.value = touroInp.value = panhouInp.value = "";
  carregar();
};

/* EDITAR */
window.editar = function(id){
  const d = dados.find(x=>x.id===id);
  editId = id;
  nomeInp.value = d.nome||"";
  racaInp.value = d.raca||"";
  touroInp.value = d.touro||"";
  panhouInp.value = d.panhou||"";
};

/* EXCLUIR */
window.excluir = async function(id){
  if(confirm("Excluir registro?")){
    await deleteDoc(doc(db,"vacas",id));
    carregar();
  }
};

const nomeInp = document.getElementById("nome");
const racaInp = document.getElementById("raca");
const touroInp = document.getElementById("touro");
const panhouInp = document.getElementById("panhou");

carregar();
</script>

</body>
</html>
