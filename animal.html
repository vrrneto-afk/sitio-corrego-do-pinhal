<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animal â€“ SÃ­tio CÃ³rrego do Pinhal</title>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --cinza:#666;
  --logo:#D0B485;
}
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:var(--bege);color:#333}
header{background:var(--logo);padding:15px 10px;text-align:center}
header img{max-width:260px;width:100%}
nav{background:var(--marrom);display:flex;flex-wrap:wrap;justify-content:center}
nav a{color:#fff;text-decoration:none;font-weight:bold;font-size:16px;padding:14px 16px}
.container{max-width:900px;margin:20px auto;padding:0 15px}
h2,h3{color:var(--marrom)}
.foto{display:flex;justify-content:center;margin:20px 0}
.foto img{max-width:100%;max-height:320px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
.card{background:#fff;padding:15px;margin-bottom:15px;border-left:6px solid var(--verde);box-shadow:0 2px 6px rgba(0,0,0,.06)}
.card p{margin:6px 0;color:var(--cinza)}
</style>
</head>

<body>

<header><img src="logo.png"></header>

<nav>
  <a href="index.html">ğŸ  InÃ­cio</a>
  <a href="lembretes.html">ğŸ“ Lembretes</a>
  <a href="animais.html">ğŸ¾ Animais</a>
  <a href="vacas.html">ğŸ„ Vacas</a>
  <a href="bezerros.html">ğŸ® Bezerros</a>
  <a href="historico.html">ğŸ“œ HistÃ³rico</a>
  <a href="farmacia.html">ğŸ’Š FarmÃ¡cia</a>
  <a href="vacinas.html">ğŸ’‰ Vacinas</a>
  <a href="leite.html">ğŸ¥› Leite</a>
  <a href="despesas.html">ğŸ’° Despesas</a>
  <a href="relatorios.html">ğŸ“Š RelatÃ³rios</a>
</nav>

<div class="container" id="conteudo">
  <p style="color:#666">Carregando animal...</p>
</div>

<div class="container" style="text-align:center;margin-bottom:40px">
  <button onclick="window.location.href='animais.html'"
    style="padding:12px 24px;font-size:16px;background:var(--marrom);color:#fff;border:none;border-radius:6px;cursor:pointer">
    â¬…ï¸ Voltar para Animais
  </button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});
const db = getFirestore(app);

const id = new URLSearchParams(location.search).get("id");
const c = document.getElementById("conteudo");

const fmt = v => {
  if(!v) return "-";
  const d = new Date(v + "T00:00:00");
  return d.toLocaleDateString("pt-BR");
};

function addMonths(d,m){
  const x=new Date(d);
  x.setMonth(x.getMonth()+m);
  return x;
}

async function load(){
  const snapA = await getDocs(collection(db,"animais"));
  const A = snapA.docs.map(d=>({_id:d.id,...d.data()}));

  const a = A.find(x=>x._id===id);
  if(!a){
    c.innerHTML="<div class='card'>Animal nÃ£o encontrado</div>";
    return;
  }

  const mae = A.find(x => x._id === a.id_mae);
  const pai = A.find(x => x._id === a.id_pai);

  const qVac = query(collection(db,"vacinas"), where("id_animal","==",id));
  const snapV = await getDocs(qVac);
  const vac = snapV.docs.map(d=>d.data());

  const qEv = query(collection(db,"eventos"), where("id_animal","==",id));
  const snapE = await getDocs(qEv);
  const eventos = snapE.docs.map(d=>d.data());

  c.innerHTML = `
    <h2><strong>${a.nome.toUpperCase()}</strong></h2>

    <div class="foto">
      <img src="${a.foto_url||'https://via.placeholder.com/600x400'}">
    </div>

    <div class="card">
      <p><strong>EspÃ©cie:</strong> ${a.especie||"-"}</p>
      <p><strong>Sexo:</strong> ${a.sexo==="M"?"Macho":"FÃªmea"}</p>
      <p><strong>RaÃ§a:</strong> ${a.raca||"-"}</p>
      <p><strong>Data de nascimento:</strong> ${fmt(a.data_nascimento)}</p>
      <p><strong>MÃ£e:</strong> ${mae ? mae.nome : "-"}</p>
      <p><strong>Pai:</strong> ${pai ? pai.nome : "-"}</p>
      <p><strong>ObservaÃ§Ãµes:</strong> ${a.observacoes||"-"}</p>
    </div>

    <h3>ğŸ’‰ Vacinas</h3>

    ${
      vac.length
        ? vac.map(v=>`
          <div class="card">
            <p><strong>${v.nome_vacina || v.vacina || v.vacina_aplicada || "-"}</strong></p>
            <p>Aplicada em: ${fmt(v.data_aplicacao)}</p>
            <p>PrÃ³xima dose: ${fmt(v.data_prox)}</p>
            <p>Status: ${v.status||"-"}</p>
            <p>Obs: ${v.observacoes||"-"}</p>
          </div>`).join("")
        : "<div class='card'>Nenhuma vacina registrada.</div>"
    }

    <h3>ğŸ“œ HistÃ³rico do Animal</h3>

    ${
      eventos.filter(e=>e.tipo_evento==="cobertura"||e.tipo_evento==="parto").length
        ? eventos
            .filter(e=>e.tipo_evento==="cobertura"||e.tipo_evento==="parto")
            .sort((a,b)=>new Date(b.data_evento)-new Date(a.data_evento))
            .map(e=>{
              if(e.tipo_evento==="cobertura"){
                const boi = A.find(x=>x._id===e.id_relacionado);
                const prev = addMonths(new Date(e.data_evento+"T00:00:00"),9);
                return `
                <div class="card">
                  <p><strong>ğŸ„ Cobertura</strong></p>
                  <p>Data: ${fmt(e.data_evento)}</p>
                  <p>Boi: ${boi ? boi.nome : "InseminaÃ§Ã£o"}</p>
                  <p>PrevisÃ£o do parto: ${prev.toLocaleDateString("pt-BR")}</p>
                </div>`;
              }

              if(e.tipo_evento==="parto"){
                const cria = A.find(x=>x._id===e.id_relacionado);
                const boi = cria && cria.id_pai ? A.find(x=>x._id===cria.id_pai) : null;
                return `
                <div class="card">
                  <p><strong>ğŸ® Parto</strong></p>
                  <p>Data: ${fmt(e.data_evento)}</p>
                  <p>Boi: ${boi ? boi.nome : "-"}</p>
                  <p>Cria: ${cria ? cria.nome : "-"}</p>
                </div>`;
              }
            }).join("")
        : "<div class='card'>Nenhum evento registrado.</div>"
    }
  `;
}

load();
</script>

</body>
</html>
