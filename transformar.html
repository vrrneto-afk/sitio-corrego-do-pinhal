<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Transformar dados</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Transformar vacas_raw em coleÃ§Ãµes definitivas</h2>
<button onclick="transformar()">ðŸ”„ Transformar dados</button>
<p id="status"></p>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
  projectId: "sitio-corrego-do-pinhal"
});

const db = firebase.firestore();

function dataISO(d){
  return new Date(d.split('/').reverse().join('-'));
}

async function transformar(){
  document.getElementById("status").innerText="Processando...";
  const snap = await db.collection("vacas_raw").get();
  const rows = snap.docs.map(d=>({id:d.id,...d.data()}));

  const porVaca = {};
  rows.forEach(r=>{
    if(!porVaca[r.nome]) porVaca[r.nome]=[];
    porVaca[r.nome].push(r);
  });

  for(const nome in porVaca){
    const registros = porVaca[nome];
    registros.sort((a,b)=>dataISO(a.panhou)-dataISO(b.panhou));

    const atual = registros[registros.length-1];

    // VACA ATUAL
    await db.collection("vacas").add({
      nome: atual.nome,
      raca: atual.raca,
      touro: atual.touro,
      panhou: atual.panhou,
      criaEm: atual.criaEm,
      criouDia: atual.criouDia || ""
    });

    // HISTÃ“RICO + BEZERROS
    for(let i=0;i<registros.length-1;i++){
      const r = registros[i];

      await db.collection("historico_crias").add({
        nomeVaca: r.nome,
        raca: r.raca,
        touro: r.touro,
        panhou: r.panhou,
        criouDia: r.criouDia,
        nomeCria: r.nomeCria
      });

      if(r.nomeCria && r.criouDia){
        await db.collection("bezerros").add({
          nome: r.nomeCria,
          mae: r.nome,
          dataNascimento: r.criouDia
        });
      }
    }
  }

  document.getElementById("status").innerText="âœ… TransformaÃ§Ã£o concluÃ­da!";
}
</script>

</body>
</html>
