<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProduÃ§Ã£o de Leite â€“ SÃ­tio CÃ³rrego do Pinhal</title>

<!-- MENU CSS (OBRIGATÃ“RIO) -->
<link rel="stylesheet" href="menu.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --amarelo:#e0a800;
  --vermelho:#c0392b;
  --cinza:#666;
  --logo:#D0B485;
}

*{
  box-sizing:border-box;
  font-family:'Inter',system-ui,-apple-system,Arial,Helvetica,sans-serif;
}

body{
  margin:0;
  background:var(--bege);
  color:#333;
}

/* HEADER */
header{
  background:var(--logo);
  padding:15px 10px;
  text-align:center;
}
header img{
  max-width:260px;
  width:100%;
}

/* CONTAINER */
.container{
  max-width:900px;
  margin:20px auto;
  padding:0 15px;
}

h2{
  margin:28px 0 10px;
  color:var(--marrom);
  display:flex;
  align-items:center;
  gap:8px;
}

/* CONTEXTO */
.contexto{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:20px;
}
.contexto select{
  flex:1;
  min-width:160px;
  padding:12px;
  border-radius:12px;
  border:1.5px solid #ddd;
  font-size:15px;
}

/* CARDS */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:14px;
  margin-bottom:20px;
}
.card{
  background:#fff;
  padding:16px;
  border-left:6px solid var(--verde);
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}
.card strong{
  font-size:22px;
  display:block;
}
.card span{
  font-size:14px;
  color:var(--cinza);
}

/* CADERNETA */
h3{
  margin:25px 0 10px;
  color:var(--marrom);
}

.tabela{
  background:#fff;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:center;
  font-size:14px;
}
th{
  background:#efe3d3;
  font-weight:700;
}
tr.baixa td{
  background:#fff6f6;
}
tfoot td{
  font-weight:800;
  background:#efe3d3;
}
</style>
</head>

<body>

<header>
  <img src="logo.png">
</header>

<!-- MENU EXTERNO -->
<div id="menu"></div>

<div class="container">
  <h2>ðŸ¥› ProduÃ§Ã£o de Leite</h2>

  <!-- CONTEXTO -->
  <div class="contexto">
    <select id="mes"></select>
    <select id="ano"></select>
    <select id="periodo">
      <option value="mensal">Mensal</option>
      <option value="bimestral">Bimestral</option>
      <option value="trimestral">Trimestral</option>
      <option value="semestral">Semestral</option>
      <option value="anual">Anual</option>
    </select>
  </div>

  <!-- CARDS -->
  <div class="cards">
    <div class="card"><strong id="cLitros">0</strong><span>Litros produzidos</span></div>
    <div class="card"><strong id="cValor">R$ 0,00</strong><span>Faturamento</span></div>
    <div class="card"><strong id="cMediaVaca">0.00</strong><span>MÃ©dia / vaca</span></div>
    <div class="card"><strong id="cDias">0</strong><span>Dias registrados</span></div>
  </div>

  <!-- CADERNETA -->
  <h3>ðŸ“’ Caderneta Mensal</h3>

  <div class="tabela">
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Litros</th>
          <th>Valor</th>
          <th>Vacas</th>
          <th>MÃ©dia / vaca</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <td>Total</td>
          <td id="tLitros">0</td>
          <td id="tValor">R$ 0,00</td>
          <td>-</td>
          <td id="tMedia">0.00</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- MENU -->
<script>
fetch("menu.html")
  .then(r=>r.text())
  .then(html=>{
    document.getElementById("menu").innerHTML = html;
    document.querySelectorAll("#menu a").forEach(a=>{
      if(a.getAttribute("href")==="leite.html"){
        a.classList.add("ativo");
      }
    });
  });
</script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});
const db = firebase.firestore();

const meses=["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

const mesSel=document.getElementById("mes");
const anoSel=document.getElementById("ano");
const periodo=document.getElementById("periodo");

const cLitros=document.getElementById("cLitros");
const cValor=document.getElementById("cValor");
const cMediaVaca=document.getElementById("cMediaVaca");
const cDias=document.getElementById("cDias");

const tbody=document.getElementById("tbody");
const tLitros=document.getElementById("tLitros");
const tValor=document.getElementById("tValor");
const tMedia=document.getElementById("tMedia");

let ROWS=[];

async function load(){
  const snap = await db.collection("producao_leite").get();
  ROWS = snap.docs.map(d=>d.data());

  mesSel.innerHTML = meses.map((m,i)=>`<option value="${i+1}">${m}</option>`).join("");
  anoSel.innerHTML = [...new Set(ROWS.map(r=>r.ano))].sort().map(a=>`<option>${a}</option>`).join("");

  anoSel.value = Math.max(...ROWS.map(r=>r.ano));
  mesSel.value = 1;

  mesSel.onchange=render;
  anoSel.onchange=render;
  periodo.onchange=render;

  render();
}

function render(){
  const m=+mesSel.value,a=+anoSel.value,p=periodo.value;

  let inicio=m;
  if(p==="bimestral") inicio=m-1;
  if(p==="trimestral") inicio=m-2;
  if(p==="semestral") inicio=m-5;
  if(p==="anual") inicio=1;
  if(inicio<1) inicio=1;

  const base=ROWS.filter(r=>r.ano===a&&r.mes>=inicio&&r.mes<=m);

  let L=0,V=0,vSoma=0;
  const dias=new Set();

  base.forEach(r=>{
    L+=r.litros_dia;
    V+=r.valor_dia;
    if(r.vacas_produzindo) vSoma+=r.litros_dia/r.vacas_produzindo;
    dias.add(`${r.dia}/${r.mes}/${r.ano}`);
  });

  cLitros.innerText=L;
  cValor.innerText=moeda(V);
  cMediaVaca.innerText=(base.length?vSoma/base.length:0).toFixed(2);
  cDias.innerText=dias.size;

  const mensal=ROWS.filter(r=>r.ano===a&&r.mes===m).sort((a,b)=>a.dia-b.dia);
  tbody.innerHTML="";

  let tl=0,tv=0,tm=0;
  mensal.forEach(r=>{
    const media=r.vacas_produzindo?r.litros_dia/r.vacas_produzindo:0;
    tl+=r.litros_dia;
    tv+=r.valor_dia;
    tm+=media;

    tbody.innerHTML+=`
      <tr>
        <td>${String(r.dia).padStart(2,"0")}/${String(m).padStart(2,"0")}/${a}</td>
        <td>${r.litros_dia}</td>
        <td>${moeda(r.valor_dia)}</td>
        <td>${r.vacas_produzindo}</td>
        <td>${media.toFixed(2)}</td>
      </tr>`;
  });

  tLitros.innerText=tl;
  tValor.innerText=moeda(tv);
  tMedia.innerText=(mensal.length?tm/mensal.length:0).toFixed(2);
}

load();
</script>

</body>
</html>
