<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
  projectId: "sitio-corrego-do-pinhal",
  storageBucket: "sitio-corrego-do-pinhal.firebasestorage.app",
  messagingSenderId: "327649698102",
  appId: "1:327649698102:web:6018468836ed7cfd319397"
};

initializeApp(firebaseConfig);
const db = getFirestore();

const meses=["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const num=v=>Number(v)||0;

let rows=[];

async function load(){
  const snap=await getDocs(collection(db,"producao_leite"));
  rows=snap.docs.map(d=>d.data());

  mes.innerHTML=meses.map((m,i)=>`<option value="${i+1}">${m}</option>`).join("");
  ano.innerHTML=[...new Set(rows.map(r=>r.ano))].sort().map(a=>`<option>${a}</option>`).join("");

  mes.value=1;
  ano.value=2025;

  periodo.onchange=renderResumo;
  mes.onchange=()=>{renderResumo();renderCaderneta();};
  ano.onchange=()=>{renderResumo();renderCaderneta();};

  renderResumo();
  renderCaderneta();
}

function renderResumo(){
  const m=+mes.value,a=+ano.value,p=periodo.value;
  let inicio=m;
  if(p==="bimestral") inicio=m-1;
  if(p==="trimestral") inicio=m-2;
  if(p==="semestral") inicio=m-5;
  if(p==="anual") inicio=1;
  if(inicio<1) inicio=1;

  const base=rows.filter(r=>r.ano===a&&r.mes>=inicio&&r.mes<=m);

  let L=0,V=0,vacaSoma=0;
  const dias=new Set();

  base.forEach(r=>{
    L+=num(r.litros_dia);
    V+=num(r.valor_dia);
    if(r.vacas_produzindo) vacaSoma+=r.litros_dia/r.vacas_produzindo;
    dias.add(`${r.dia}/${r.mes}/${r.ano}`);
  });

  litros.innerText=L;
  total.innerText=moeda(V);
  mediaDia.innerText=(dias.size?L/dias.size:0).toFixed(2);
  mediaVaca.innerText=(base.length?vacaSoma/base.length:0).toFixed(2);
}

function renderCaderneta(){
  const m=+mes.value,a=+ano.value;
  const f=rows.filter(r=>r.mes===m&&r.ano===a);

  let L=0,V=0,med=0;
  tbody.innerHTML="";

  f.forEach(r=>{
    L+=num(r.litros_dia);
    V+=num(r.valor_dia);
    med+=r.vacas_produzindo?r.litros_dia/r.vacas_produzindo:0;

    tbody.innerHTML+=`
    <tr>
      <td>${String(r.dia).padStart(2,"0")}/${String(m).padStart(2,"0")}/${a}</td>
      <td>${r.litros_dia}</td>
      <td>${moeda(r.valor_dia)}</td>
      <td>${r.vacas_produzindo}</td>
      <td>${(r.vacas_produzindo?r.litros_dia/r.vacas_produzindo:0).toFixed(2)}</td>
    </tr>`;
  });

  tLitros.innerText=L;
  tValor.innerText=moeda(V);
  tMedia.innerText=(f.length?med/f.length:0).toFixed(2);
}

load();
</script>
