<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Histórico de Crias</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #fff;
  color: #333;
}

header {
  text-align: center;
  padding: 20px 10px;
}

nav {
  background: #7a1f2b;
  padding: 10px;
  text-align: center;
}

nav a {
  color: #fff;
  margin: 0 10px;
  text-decoration: none;
  font-weight: bold;
}

nav a.active {
  text-decoration: underline;
}

h2 {
  margin: 20px;
}

table {
  width: 95%;
  margin: auto;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
}

th {
  background: #f3e6c9;
  cursor: pointer;
}

.admin-btn {
  background: #7a1f2b;
  color: #fff;
  border: none;
  padding: 5px 8px;
  margin: 2px;
  cursor: pointer;
}

.admin-area {
  text-align: center;
  margin: 10px;
}

.hidden {
  display: none;
}
</style>
</head>

<body>

<header>
  <h1>SÍTIO CÓRREGO DO PINHAL</h1>
  <p>Família Ribeiro<br>Data atual: <span id="dataHoje"></span></p>
</header>

<nav>
  <a href="index.html">Início</a>
  <a href="vacas.html">Vacas</a>
  <a href="historico.html" class="active">Histórico de Crias</a>
  <a href="bezerros.html">Bezerros(as)</a>
  <a href="vacinacao.html">Vacinação</a>
</nav>

<div class="admin-area">
  <button id="btnAdmin" class="admin-btn">⚙️ Administrador</button>
</div>

<h2>Histórico de Crias</h2>

<table id="tabela">
<thead>
<tr>
  <th onclick="ordenar(0)">Vaca</th>
  <th onclick="ordenar(1)">Touro</th>
  <th onclick="ordenar(2)">Panhou cria</th>
  <th onclick="ordenar(3)">Criou dia</th>
  <th onclick="ordenar(4)">Nome da cria</th>
  <th class="admin hidden">Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  doc, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_DOMINIO",
  projectId: "SEU_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tbody = document.querySelector("tbody");
let admin = false;
let dados = [];

document.getElementById("dataHoje").innerText =
  new Date().toLocaleDateString("pt-BR");

document.getElementById("btnAdmin").onclick = () => {
  admin = !admin;
  document.querySelectorAll(".admin").forEach(e =>
    e.classList.toggle("hidden", !admin)
  );
  carregar();
};

async function carregar() {
  tbody.innerHTML = "";
  dados = [];

  const vacasSnap = await getDocs(collection(db, "vacas"));
  const histSnap = await getDocs(collection(db, "historico_crias"));

  const historicoMap = {};
  histSnap.forEach(d => historicoMap[d.id] = d.data());

  vacasSnap.forEach(docu => {
    const v = docu.data();
    const h = historicoMap[docu.id] || {};

    const nomeCria =
      h.nomeCria || h.nome_da_cria || h.cria || "";

    dados.push({
      id: docu.id,
      vaca: v.nome || "",
      touro: v.touro || "",
      panhou: v.panhou_cria || "",
      criou: h.criou_dia || "",
      cria: nomeCria
    });
  });

  render();
}

function render() {
  tbody.innerHTML = "";
  dados.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.vaca}</td>
      <td>${d.touro}</td>
      <td>${d.panhou}</td>
      <td>${d.criou}</td>
      <td>${d.cria}</td>
      ${admin ? `
      <td class="admin">
        <button class="admin-btn" onclick="editar('${d.id}')">Editar</button>
        <button class="admin-btn" onclick="excluir('${d.id}')">Excluir</button>
      </td>` : ""}
    `;
    tbody.appendChild(tr);
  });
}

window.editar = async (id) => {
  const criou = prompt("Data da cria (dd/mm/aaaa):");
  const nome = prompt("Nome da cria:");

  if (!criou && !nome) return;

  await setDoc(doc(db, "historico_crias", id), {
    criou_dia: criou || "",
    nomeCria: nome || ""
  }, { merge: true });

  carregar();
};

window.excluir = async (id) => {
  if (!confirm("Excluir histórico desta cria?")) return;
  await deleteDoc(doc(db, "historico_crias", id));
  carregar();
};

let ordemAsc = true;
window.ordenar = (col) => {
  dados.sort((a, b) => {
    const v1 = Object.values(a)[col] || "";
    const v2 = Object.values(b)[col] || "";
    return ordemAsc
      ? v1.localeCompare(v2, "pt-BR", { numeric: true })
      : v2.localeCompare(v1, "pt-BR", { numeric: true });
  });
  ordemAsc = !ordemAsc;
  render();
};

carregar();
</script>

</body>
</html>
